<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIHierarchies</title>

    <link rel="icon" href="Images/logo-hcircle-dark.png">

    <style>
        .dot {
            height: 25px;
            width: 25px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot scrolls {
            overflow-x: scroll;
            overflow-y: hidden;
            height: 80px;
            white-space: nowrap
        }


        /************/

        body {
            padding: 50px;
            font-family: Arial;
            font-size: 10px;
        }

        .axis path,
        .axis line {

            stroke: #000;
            stroke-width: 0px;
            opacity: 0;
            shape-rendering: geometricPrecision;
            /*shape-rendering: crispEdges;*/
        }

        /*  .x.axis path {
            display: none;
        } */

        .tick text {

            opacity: 0;
        }

        .line {

            opacity: 0.5;

        }
    </style>
</head>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"
    integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.0.1/intro.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>





<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://kit.fontawesome.com/ae1e2e7d99.js" crossorigin="anonymous"></script>
<script src="algorithm.js"></script>
<script src="mtree-guidedtour.js"></script>
<script src="mtree-trainingquestions.js"></script>
<script src="mtree-experimentquestions.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
<script src="labeler.js"></script>




<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.0.1/introjs.min.css" />
<link rel="stylesheet" type="text/css" href="./assets/styles.css" />



<body>





    <div class="container-fluid">
        <div class="row" id="sticky" style="background-color: white;">
            <div class="col-4">

                <fieldset class="border p-2" style="margin-top:150px;">
                    <!--<legend class="w-auto">Choose layout</legend>-->
                    <br>
                    <button type="button" class="btn btn-md" id="btn-changeonlylayout"
                        style="color: white;background-color:#155446;">Changes-only layout</button>

                    <button type="button" class="btn btn-md" id="btn-entirelayout"
                        style="color: white;background-color:#155446;">Entire layout</button>

                    <br><br>
                    <!--
                    <div class="form-check form-switch row" id="togglediv"><span><label>Before hierarchy</label><input
                                class="form-check-input" type="checkbox" name="hierarchy-toggle" id="tog-hierarchy"
                                style="margin-left:20px; margin-right: 20px;" data-offstyle="danger"><label>After
                                hierarchy</label></span>
                    </div>
                    -->
                    <br>
                    <br>
                    <label for="browser">Search:</label>
                    <input list="search-nodes-list" name="search-nodes" id="search-nodes">
                    <button type="button" class="btn btn-md" id="btn-search"
                        style="color: white;background-color:#155446;">Search</button>

                    <button type="button" class="btn btn-md" id="btn-clear"
                        style="color: white;background-color:#155446;">Clear</button>

                    <datalist id="search-nodes-list">
                    </datalist>


                </fieldset>

            </div>

            <div class="col-6" style="border: 2px outset black; margin-top: 2%;" id="qandamodule">

                <p id="question" style="margin-top: 2%;">

                </p>

                <hr class='border border-primary border-3 opacity-75'>

                <button class="btn btn-outline-success" type="button" data-bs-toggle="collapse" id="btn-hint"
                    data-bs-target="#collapseElement" aria-expanded="false" aria-controls="collapseExample">
                    <i class="fa-solid fa-lightbulb" style="color:rgb(244, 166, 11);"></i> Show hint
                </button>
                <br />
                <div class="collapse" id="collapseElement">

                    <p id="hint" style="background-color: azure; text-align: center; margin-top: 2%;"> </p>

                </div>

                <br />


                <div class="form-check" id="qanda_options">

                </div>



                <div class="btn-group btn-group-md" role="group" aria-label="Basic mixed styles example"
                    style="margin-bottom: 1%;">
                    <button type="button" class="btn btn-md" id="btn-backquestion"
                        style="color: white;background-color:#155446;">Back</button>

                    <span id="span-nextquestion">
                        <button type="button" class="btn btn-md" id="btn-nextquestion"
                            style="margin-left: 10px; color:white;background-color:#155446;">

                            Next</button></span>
                </div>



            </div>
            <div class=" col-2">
            </div>
        </div>


        <div class="row">
            <!--
            <div class="col-2" style=" margin-left: 20px; color:black;">

                <fieldset class="border p-2" style="margin-top:150px;">
                    <legend class="w-auto">Dataset</legend>
                    <button type="button" id="btn-swapdataset" class="btn btn-primary" style="margin-top:50px;">
                        <i class="fa-solid fa-right-left"></i>
                        <h5>Swap primary and secondary datasets</h5>
                    </button>


                    <span class="form-check" style="margin-top:20px;">
                        <label class="form-check-label" for="fileversion0radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion0radio"
                                checked>
                            Default
                        </label>
                    </span>

                    <span class="form-check" style=" margin-top:10px;">
                        <label class="form-check-label" for="fileversion1radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion1radio">
                            <span style="float:left;">Default 2</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="fileversion5radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion5radio">
                            <span style="float:left;">Project Team</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="fileversion2radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion2radio">

                            <span style="float:left;">Log Files</span>

                        </label>
                    </span>

                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="fileversion6radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion6radio">

                            <span style="float:left;">Book Classification</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:10px; ">
                        <label class="form-check-label" for="fileversion3radio">
                            <input class="form-check-input" type="radio" name="fileversionradio" id="fileversion3radio">

                            <span style="float:left;">UK SIC - v4 and v3.1</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="filterdata">
                            <input class="form-check-input" type="checkbox" id="filterdatacheck" name="filterdata"
                                value="yes">

                            <span style="float:left;">Filter Data - (A,B,C)</span>
                        </label>

                    </span>
                    <br>
                </fieldset>


                <fieldset class="border p-2" style="margin-top:100px;">
                    <legend class="w-auto">Styling level lines</legend>
                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="fillcolorradio">
                            <input class="form-check-input" type="radio" name="levelcolorradio" id="fillcolorradio">
                            <span>Fill level lines with color
                                <span class="dot"
                                    style="background: radial-gradient(circle, rgba(238,174,202,1) 0%, rgba(148,187,233,1) 100%);">
                                </span>
                            </span>
                        </label>
                    </span>


                    <span class="form-check" style="margin-top:10px;">
                        <label class="form-check-label" for="fillnoneradio">
                            <input class="form-check-input" type="radio" name="levelcolorradio" id="fillnoneradio"
                                checked>
                            <span>No color
                                <span class="dot" style="background-color: blue;"></span>
                            </span>
                        </label>
                    </span>


                </fieldset>



                <fieldset class="border p-2" style="margin-top:100px;">
                    <legend class="w-auto">Change color theme</legend>
                    <div class="form-check" style="margin-top:50px;">
                        <label class="form-check-label" for="blueredradio">
                            <input class="form-check-input" type="radio" name="nodecolorradio" id="blueredradio"
                                checked>
                            Blue/Red Theme (default)
                            <br>
                            <span class="dot" style="background-color: blue;"></span> +
                            <span class="dot" style="background-color: red;"></span> =
                            <span class="dot" style="background-color: purple;"></span>
                        </label>
                    </div>
                    <div class="form-check" style="margin-top:20px;">
                        <label class="form-check-label" for="orangeblueradio">
                            <input class="form-check-input" type="radio" name="nodecolorradio" id="orangeblueradio">
                            Orange/blue Theme
                            <br>
                            <span class="dot" style="background-color: orange;"></span> +
                            <span class="dot" style="background-color: blue;"></span> =
                            <span class="dot" style="background-color: yellowgreen;"></span>
                        </label>
                    </div>

                </fieldset>


                <fieldset class="border p-2" style="margin-top:100px;">
                    <legend class="w-auto">Change node shape</legend>
                    <div class="form-check" style="margin-top:50px; ">
                        <label class="form-check-label" for="solidshaperadio">
                            <input class="form-check-input" type="radio" name="nodeshaperadio" id="solidshaperadio">
                            Solid Circles in different colors
                            <br>
                            <span class="dot" style="background-color: blue;"></span> +
                            <span class="dot" style="background-color: red;"></span> =
                            <span class="dot" style="background-color: purple;"></span>

                        </label>
                    </div>
                    <div class="form-check" style=" margin-top:20px;">
                        <label class="form-check-label" for="hollowshaperadio">
                            <input class="form-check-input" type="radio" name="nodeshaperadio" id="hollowshaperadio"
                                checked>
                            A combination of hollow and solid circles
                            <br>
                            <span style="background-color: white;  border-color:blue; border-style:solid; border-width: 5px; height: 25px;
                        width: 25px; border-radius: 50%; display: inline-block;"></span> +
                            <span class="dot" style="background-color: blue;"></span> =
                            <i style="color:blue;" class="fa-regular fa-circle-dot fa-2xl"></i>
                        </label>

                    </div>
                </fieldset>




                <fieldset class="border p-2" style="margin-top:100px;">
                    <legend class="w-auto">Layout</legend>

                    <span class="form-check" style="margin-top:20px; ">
                        <label class="form-check-label" for="sideradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="sideradio">
                            <span class="text-justify"> Trees are laid side-by-side</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="def_tbradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="def_tbradio">
                            <span class="text-justify">
                                Default Top-bottom layout
                            </span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="tbradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="tbradio">
                            <span class="text-justify">
                                Top-bottom layout</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="lrradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="lrradio">
                            <span class="text-justify"> Left-right layout</span>
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="lrleavesradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="lrleavesradio" checked>
                            <span class="text-justify">
                                Left-right leaves facing-first layout</span>
                        </label>
                    </span>


                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="tlbrradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="tlbrradio">
                            <span class="text-justify"> Top-left and bottom right layout</span>
                        </label>
                    </span>


                    <span class=" form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="ang_tlbrradio">
                            <input class="form-check-input" type="radio" name="layoutradio" id="ang_tlbrradio">
                            <span class="text-justify">Angled top-left and bottom-right layout</span>
                        </label>
                    </span>


                </fieldset>


                <fieldset class="border p-2" style="margin-top:100px;">
                    <legend class="w-auto">Type of links</legend>
                    <span class="form-check" style="margin-top:50px; ">
                        <label class="form-check-label" for="straightlradio">
                            <input class="form-check-input" type="radio" name="linesradio" id="straightlradio" checked>

                            Straight lines
                        </label>
                    </span>

                    <span class="form-check" style="margin-top:20px;">
                        <label class=" form-check-label" for="curvedlradio">
                            <input class="form-check-input" type="radio" name="linesradio" id="curvedlradio">

                            <span style="width:100%;">Curved links</span>
                        </label>
                    </span>

                </fieldset>

            </div>
 -->

            <!--  <div class="col-1">
            </div> -->
            <div id="content" class="col-12">


            </div>
            <!-- <div class="col-1">
            </div> -->

        </div>





    </div>

    <script>





        var qcounter = -1;
        var logObject = [];


        //LOG FILES
        var fileversion = "File4";

        //var fileversion = "File0";

        var swapdataset = "h2";

        var h2 = "";
        var h1 = "";


        var h2_tree = "", h1_tree = "";
        var mtree = "";
        const vizID = "mergedtree";
        const pageID = "mtree";
        var screenSize = localStorage.getItem("screenSize");


        var title = [];

        update_log("", "landed on the mergedtree page", "", "", "", "", "", "", "");
        var stree_label_size = 10;
        var label_size = 15;

        var mtree_radius = 6;
        var circle_stroke = 4;
        var layout = "changeonlylayout";






        title = ["Before Hierarchy", "After Hierarchy", "Merged Tree"];

        d3.queue()
            .defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced-v5.csv")
            .defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced-v5.csv")
            //.defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
            //.defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
            .await(function (error, h2, h1) {
                if (error) throw error;

                else
                    runScript_tabs(h1, h2);
            });

        d3.select("#btn-changeonlylayout").on("click", function () {
            layout = "changeonlylayout";
            update_log("btn-changeonlylayout", "button", "display changes-only layout", "click", "", "", "", "", "", "");

            d3.queue()
                .defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced-v5.csv")
                .defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced-v5.csv")
                .await(function (error, h2, h1) {
                    if (error) throw error;

                    else
                        runScript_tabs(h1, h2);
                });
        });

        d3.select("#btn-entirelayout").on("click", function () {
            layout = "entirelayout";
            update_log("btn-entirelayout", "button", "display the entire layout", "click", "", "", "", "", "", "");
            d3.queue()
                .defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced-v5.csv")
                .defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced-v5.csv")
                .await(function (error, h2, h1) {
                    if (error) throw error;

                    else
                        runScript_tabs(h1, h2);
                });
        });


        /*
                d3.select("#btn-swapdataset").on("click", function () {
                    update_log("btn-swapdataset", "button", "swapping datasets");
        
                    console.log("Swapdataset");
        
                    fileversion = "File2";
        
        
        
                    if (swapdataset == "h2") {
                        d3.queue()
                            //.defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced.csv")
                            //.defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced.csv")
                            .defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
                            .defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
                            .await(function (error, h2, h1) {
                                if (error) throw error;
        
                                else
                                    runScript_tabs(h2, h1);
                            });
                        swapdataset = "h1";
                    }
                    else {
                        d3.queue()
                            .defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
                            .defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
                            .await(function (error, h2, h1) {
                                if (error) throw error;
        
                                else
                                    runScript_tabs(h2, h1);
                            });
                        swapdataset = "h2";
                    }
        
                });
                */



        function runScript_tabs(h2, h1) {

            //console.log(h2);
            //console.log(h1);


            runScript_mergedtree(h2, h1);


            var urlpage = new URLSearchParams(window.location.search).get('page');
            //console.log("page reached in mtree " + pageID);

            if (urlpage == "guidedtour") {
                d3.select("#qandamodule")
                    .style("opacity", 0);
                guidedtour();
            }

            else if (urlpage == "trainingquestions") {
                d3.select("#sticky")
                    .attr("class", "row sticky-top");
                trainingquestions(0);
                qcounter = -1;
            }

            else if (urlpage == "experimentquestions") {
                d3.select("#btn-hint")
                    .remove();

                d3.select("#collapseElement")
                    .remove();

                d3.select("#btn-backquestion")
                    .remove();

                experimentquestions(0);
            }

        }











        const urlpage = new URLSearchParams(window.location.search).get('page');





        var qid = "";

        d3.select("#btn-nextquestion")
            .on("click", function () {

                console.log("click on butn");
                //console.log(d3.select("#btn-nextquestion")._groups[0][0].disabled);


                d3.select("#btn-nextquestion")._groups[0][0].disabled = true;
                // console.log("submitted" + document.querySelector(".radiobuttons").checked);

                if (urlpage == "trainingquestions")
                    qid = "T";
                else
                    qid = "E";

                if (!d3.select(".radiobuttons").empty()) {
                    console.log(qcounter);
                    update_log("btn-nextquestion", "button", "display question", "click", qid + qcounter, list_questions[qcounter].question, selected_value, list_questions[qcounter].answer, score);
                }

                if (qcounter == -1)
                    qcounter = qcounter + 2;
                else
                    qcounter++;

                //console.log("QC " + qcounter);

                if (urlpage == "trainingquestions") {
                    //update_log("btn-nextquestion", "button", "display training question " + qcounter);
                    d3.select("#collapseElement")
                        .attr("class", "collapse");
                    d3.select("#btn-hint")
                        .html("<i class='fa-solid fa-lightbulb' style='color:rgb(244, 166, 11);'></i> Show hint");
                    trainingquestions(qcounter);
                }
                else {
                    //update_log("btn-nextquestion", "button", "display experiment question " + qcounter);
                    experimentquestions(qcounter);
                }
            });

        d3.select("#btn-backquestion")
            .on("click", function () {
                qcounter--;
                if (urlpage == "trainingquestions") {
                    //update_log("btn-backquestion", "button", "display training question " + qcounter);
                    trainingquestions(qcounter);
                }
                else {
                    //update_log("btn-backquestion", "button", "display experiment question " + qcounter);
                    experimentquestions(qcounter);
                }
            });

        /*  d3.select("#span-nextquestion")
             .on("click", function () {
                 //console.log(d3.select("#btn-nextquestion").property("disabled"));
                 //console.log(document.getElementById("btn-nextquestion").disabled);
                 if (d3.select("#btn-nextquestion")._groups[0][0].disabled == true)
                     alert("please select an answer");
             }); */





        /* function filterData(array) {
            for (var i = array.children.length - 1; i >= 0; i--) {

                if (!(array.children[i].data.data.child === 'A' || array.children[i].data.data.child === 'B' || array.children[i].data.data.child === 'C'))
                    array.children.splice(i, 1);

            }

            return array;
        } */

        var width = window.innerWidth;
        var height = 2000;
        var level_offset = 150;




        function runScript_mergedtree(h2, h1) {
            //console.log("MERGEDTREE");

            //console.log(h2);
            //console.log(h1);

            //console.log(window.innerWidth + " " + window.innerHeight + " ");

            d3.select("#content").select("svg").remove();

            var radius = 10;

            /* if (d3.select("#fileversion3radio")._groups[0][0].checked == true)
                radius = 10;
            else radius = 15; */


            d3.select("#solidhollowcircle")
                .append("circle")
                .attr("cx", 500)
                .attr("cy", 500)
                .attr("r", 500)
                .style("fill", "blue")
                .style("stroke-width", "30px")
                .style("stroke", "red");


            //mergedtree size
            var margin = { top: 30, right: 30, bottom: 30, left: 120 };
            //width = 2000 - margin.left - margin.right,
            //height = 2500 - margin.top - margin.bottom;




            var mergedtree_svg = d3
                .select("#content")
                .append("svg")
                .attr("id", "mergedtree_svg")

                /*  .call(d3.zoom().on("zoom", function () {
                     mergedtree_svg.attr("transform", d3.event.transform)
                 })) */

                .attr("width", window.innerWidth * 1.5)
                .attr("height", height);




            if (d3.select("#tooltip").empty())
                d3.select("#content")
                    .append("div")
                    .style("width", "300px")
                    .style("height", "150px")
                    //.style("width", "850px")
                    //.style("height", "350px")
                    .style("position", "absolute")
                    .style("opacity", 0)
                    .attr("id", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("font-size", "20px")
                    .style("color", "black")
                    .style("border-width", "3px")
                    .style("border-radius", "15px")
                    .style("padding", "15px");


            const depthArray = [];

            //console.log(h2);
            //console.log(h1);

            stratify = d3
                .stratify()
                .id(function (d) {
                    //console.log(d.child);
                    return d.child;
                })
                .parentId(function (d) {
                    //console.log(d.parent);
                    return d.parent;
                });

            //console.log(window.h1);
            var h1_struct = stratify(h1);
            //console.log(h1_struct.children);


            var h2_struct = stratify(h2);
            //console.log(h2_struct);



            var h2_root = d3.hierarchy(h2_struct);
            var h1_root = d3.hierarchy(h1_struct);

            var nodes_list = [];
            var h1list = [], h2list = [];
            for (i = 0; i < h2_root.descendants().length; i++) {
                h2list.push(h2_root.descendants()[i].data.data.description_child);
            }
            for (i = 0; i < h1_root.descendants().length; i++) {
                h1list.push(h1_root.descendants()[i].data.data.description_child);
            }
            let intersection = h1list.filter(x => h2list.includes(x));
            let h1diff = h1list.filter(x => !h2list.includes(x));
            let h2diff = h2list.filter(x => !h1list.includes(x));

            for (var i = 0; i < intersection.length; i++)
                nodes_list.push(intersection[i]);

            for (var i = 0; i < h1diff.length; i++)
                nodes_list.push(h1diff[i]);

            for (var i = 0; i < h2diff.length; i++)
                nodes_list.push(h2diff[i]);

            d3.select("#search-nodes-list")
                .selectAll("option")
                .data(nodes_list)
                .enter()
                .append("option")
                .attr("value", function (d) {
                    //console.log(d.data.data.description_child);
                    return d;
                })
                .text(function (d) {
                    return d;
                });


            /* d3.select("#search-nodes-list")
            .selectAll("option")
            .data(h1_root.descendants())
            .enter()
            .append("option")
            .attr("value", function (d) {
                //console.log(d.data.data.description_child);
                return d.data.data.child;
            })
            .text(function (d) {
                return d.data.data.description_child;
            }); */



            /*
                        d3.select("#tog-hierarchy")
                            .on("change", function () {
                                d3.select("#search-nodes").node().value = "";
                                if (this.checked) {
                                    update_log("tog-hierarchy", "toggle switch", "value is at " + this.checked + " showing h2 elements", "click", "", "", "", "", "");
                                    d3.select("#search-nodes-list")
                                        .selectAll("option")
                                        .remove();
                                    d3.select("#search-nodes-list")
                                        .selectAll("option")
                                        .data(h2_root.descendants())
                                        .enter()
                                        .append("option")
                                        .attr("value", function (d) {
                                            //console.log(d);
                                            return d.data.data.child;
                                        })
                                        .text(function (d) {
                                            return d.data.data.description_child;
                                        });
                                }
                                else {
                                    update_log("tog-hierarchy", "toggle switch", "value is at " + this.checked + " showing h1 elements", "click", "", "", "", "", "");
                                    d3.select("#search-nodes-list")
                                        .selectAll("option")
                                        .remove();
                                    d3.select("#search-nodes-list")
                                        .selectAll("option")
                                        .data(h1_root.descendants())
                                        .enter()
                                        .append("option")
                                        .attr("value", function (d) {
                                            //console.log(d);
                                            return d.data.data.child;
                                        })
                                        .text(function (d) {
                                            return d.data.data.description_child;
                                        });
            
                                }
            
                            });
                            */



            var child = "", parent = "", childsplit = "", parentsplit = "";

            d3.select("#btn-clear")
                .on("click", function () {
                    update_log("btn-clear", "button", "Clear the value in the search box", "click", "", "", "", "", "")
                    d3.select("#search-nodes").node().value = "";

                    d3.selectAll(".selected")
                        .style("stroke", "blue");


                    d3.selectAll(".selected").each(function (d) {

                        if (d3.select(this).attr("class").includes("inner")) {
                            d3.select(this)
                                .style("stroke-width", mtree_radius);
                        }

                        d3.select(this)
                            .classed("selected", false);

                        for (var i = 0; i < this.parentNode.childNodes.length; i++) {
                            var y = d3.select(this.parentNode).attr("transform").split(", ")[1].replace(")", "");
                            d3.select(this.parentNode.childNodes[3]).style("fill", "silver")
                                .style("font-size", label_size - parseInt(y) / 50);

                        }
                    });


                });

            d3.select("#btn-search")
                .on("click", function () {



                    //if (document.getElementById("tog-hierarchy").checked) {
                    child = d3.select("#search-nodes").node().value;
                    update_log("btn-search", "button", "Search for value in the search box " + child, "click", "", "", "", "", "");


                    //console.log("CHILD " + child);

                    var split_element = child.split("/");
                    //console.log(split_element);

                    childsplit = split_element[split_element.length - 1];
                    //split_element.pop();
                    //parent = split_element.join("/");
                    //parentsplit = split_element[split_element.length - 1];
                    //console.log(childsplit + " " + parentsplit);
                    //console.log(child + " " + parent);

                    var flag = 0;
                    //console.log(mtree.descendants().length);


                    /*
                    mtree.descendants().reverse().forEach(function (element) {
                        flag = 0;
    
    
    
                        if ((element.data.data.linkcolor == "blue") || element.children == null) {
                            for (var i = 0; i < element.descendants().length; i++) {
                                //console.log("entering check" + element.descendants()[i].data.data.child);
                                if ((element.descendants()[i].data.data.linkcolor == "blue") && element.descendants()[i].children == null) {
                                    //console.log(element.descendants()[i].data.data.child + " passed check");
                                    flag += 1;
                                }
    
                            }
                            //console.log(element.data.data.child + " " + flag + " " + (element.descendants().length));
                            if (flag == element.descendants().length - 1 || element.children == null) {
                                //console.log("collapse " + element.data.data.child);
                                collapse(element);
                            }
    
                        }
                        //else
                        // console.log("expandedpc  " + element.data.data.child + " " + element.data.data.linkcolor + " " + element.children.length);
                    });
                    */

                    mtree.descendants().forEach(function (element) {

                        split_element = child.split("/");
                        //console.log(split_element.join("/"));
                        //console.log(element.data.data.child);
                        if (split_element.join("/") == (element.data.data.child)) {
                            //console.log("h1");
                            for (var i = 0; i < element.ancestors().length; i++) {
                                var id = "mergedtree_" + element.ancestors()[i].data.data.child.replaceAll(/\//g, "")
                                    .replaceAll(".", "")
                                    .replaceAll(" ", "")
                                    .replaceAll("(", "")
                                    .replaceAll(")", "")
                                    .toLowerCase();
                                document.getElementById(id).scrollIntoView(true);



                                if (document.getElementsByClassName(id + "_outer")[0].style.stroke == "blue" || document.getElementsByClassName(id + "_outer")[0].style.stroke == "darkorange")
                                    d3.select("." + id + "_outer")
                                        .style("stroke", "darkorange")
                                        .classed("selected", "true");
                                //.style("stroke-width", circle_stroke);
                                else
                                    d3.select("." + id + "_inner")
                                        .style("stroke", "darkorange")
                                        .style("stroke-width", 4)
                                        .classed("selected", "true");

                                d3.select("." + id + ".text")
                                    .style("fill", "darkorange")
                                    .style("font-size", 20);


                            }

                        }
                        else
                            for (var i = 0; i < element.ancestors().length; i++) {
                                //console.log(element);
                                //console.log(element.ancestors()[i].data.data.child + " " + split_element.join("/"));
                                //console.log(element.depth);
                                if (element.ancestors()[i].depth > 1) {
                                    //console.log(split_element.join("/"));
                                    //console.log(element.ancestors()[i].data.data.description);
                                    if (split_element.join("/").includes(element.ancestors()[i].data.data.child)) {

                                        //console.log("MATCH COLLAPSE" + element.ancestors()[i].data.data.description);
                                        //console.log(element.ancestors()[i].data.data.description);
                                        //if (element.ancestors()[i].data.data.child == "root/projects/hcil/kiddiglib")
                                        // console.log("MATCH ELEMENT");
                                        //flag += 1;
                                        //console.log(element.data.data.child);
                                        //console.log(element.ancestors()[i].data.data.child);
                                        //console.log(element.ancestors()[i]);
                                        expand(element.ancestors()[i]);




                                        /*  if (split_element.join("/") == element.ancestors()[i].data.data.description) {
                                             console.log("break " + element.ancestors()[i].data.data.description);
                                             break;
                                         } */



                                        setTimeout(() => {
                                            // console.log(child);
                                            //console.log("mergedtree_" + split_element[split_element.length - 1]);
                                            document.getElementById("mergedtree_" + split_element[split_element.length - 1].replaceAll(/\//g, "")
                                                .replaceAll(".", "")
                                                .replaceAll(" ", "")
                                                .replaceAll("(", "")
                                                .replaceAll(")", "")
                                                .toLowerCase()).scrollIntoView(true);

                                            for (var ii = split_element.length - 1; ii >= 0; ii--) {

                                                var id = "mergedtree_" + split_element[ii]
                                                    .replaceAll(/\//g, "")
                                                    .replaceAll(".", "")
                                                    .replaceAll(" ", "")
                                                    .replaceAll("(", "")
                                                    .replaceAll(")", "")
                                                    .toLowerCase();
                                                // console.log(id);
                                                //console.log(d3.select("#" + id));

                                                if (document.getElementsByClassName(id + "_outer")[0].style.stroke == "blue" || document.getElementsByClassName(id + "_outer")[0].style.stroke == "darkorange")
                                                    d3.select("." + id + "_outer")
                                                        .style("stroke", "darkorange")
                                                        .classed("selected", "true");
                                                //.style("stroke-width", circle_stroke);
                                                else
                                                    d3.select("." + id + "_inner")
                                                        .style("stroke", "darkorange")
                                                        .style("stroke-width", 4)
                                                        .classed("selected", "true");

                                                d3.select("." + id + ".text")
                                                    .style("fill", "red")
                                                    .style("font-size", 20)

                                            }
                                        }, 1000);




                                        //}


                                        //break;
                                    }
                                    /* else {
                                        split_element.pop();
                                    } */
                                }
                            }
                    });


                    //console.log(mtree.descendants()[0]);
                    //console.log(mtree.descendants()[0]);
                    //d3.select("#mergedtree").selectAll(".nodes").remove();
                    //d3.select("#mergedtree").selectAll(".link").remove();
                    mergedtree(mtree.descendants()[0], hier_root);




                });







            var h2_dims = findDimensions(h2_root);
            var h1_dims = findDimensions(h1_root);

            //console.log(h2_dims);

            var h2color = "blue", h1color = "blue", mergedcolor = "";






            //console.log(h1_root.children);

            //no h2 and h1 trees
            h2tree(h2_root);
            h1tree(h1_root);


            //var arrDims = compareDimensions(h2_dims, h1_dims);
            //var hier = createHierarchy(arrDims, h2_root.descendants(), h1_root.descendants());


            var hier_arr = [];
            //hier_arr = compareDimensions(h2_dims, h1_dims, h2_root.descendants(), h1_root.descendants());
            hier_arr = bt_compareDimensions(h2_dims, h1_dims, h2_root.descendants(), h1_root.descendants(), h2color, h1color, mergedcolor);
            //console.log(hier_arr);


            var hier_struct = stratify(hier_arr);

            //mergedtree size
            //width = 1500, height = 1000;

            var hier_root = d3.hierarchy(hier_struct);

            //console.log(hier_root);

            var tree = d3
                .tree();

            //.nodeSize([200, 600]);
            //.size([Math.round(window.innerWidth * .75), Math.round(window.innerHeight * .75)]);


            var cluster = d3
                .cluster()
                //.nodeSize([200, 600]);
                .size([Math.round(width * .95), Math.round(height * .95)]);

            //console.log(hier_root);


            //if (d3.select("#leavesdiffheightradio")._groups[0][0].checked == true)
            mtree = tree(hier_root);
            mtree
                .sort(function (a, b) {
                    return a.data.data.child.toLowerCase().localeCompare(b.data.data.child.toLowerCase());
                });
            //else if (d3.select("#leavessameheightradio")._groups[0][0].checked == true)
            //mtree = cluster(hier_root);

            //var data = mtree;
            var tree_start = [100, 400];


            //console.log(parseInt(margin.left + 40) + " " + parseInt(margin.top + 400));
            mergedtree_svg
                .append("g")
                .attr("id", "mergedtree")
                .attr("transform",
                    "translate(" + tree_start[0] + "," + tree_start[1] + ")");
            //"translate(" + window.innerWidth / 2 + "," + tree_start[1] + ")");



            if (layout == "changeonlylayout") {
                var flag = 0;
                mtree.descendants().reverse().forEach(function (element) {
                    flag = 0;
                    //console.log(element.data.data.child);
                    if ((element.data.data.linkcolor == "blue") || element.children == null) {
                        for (var i = 0; i < element.descendants().length; i++) {
                            //console.log("entering check" + element.descendants()[i].data.data.child);
                            if ((element.descendants()[i].data.data.linkcolor == "blue") && element.descendants()[i].children == null) {
                                //console.log(element.descendants()[i].data.data.child + " passed check");
                                flag += 1;
                            }
                        }
                        //console.log(element.data.data.child + " " + flag + " " + (element.descendants().length));
                        if (flag == element.descendants().length - 1 || element.children == null) {
                            //console.log("collapse " + element.data.data.child);
                            collapse(element);
                        }

                    }
                    //else
                    // console.log("expandedpc  " + element.data.data.child + " " + element.data.data.linkcolor + " " + element.children.length);
                });
            }



            //console.log(mtree.descendants()[0]);

            mergedtree(mtree.descendants()[0], hier_root);








            mergedtree_svg
                .append("g")
                .attr("class", "titleg");

            mergedtree_svg
                .select(".titleg")
                .selectAll("text")
                .data(title)
                .enter()
                .append("text")
                .style("font-size", "20px")
                .attr("dy", "4em")
                .attr("x", function (d, i) {
                    if (i == 0)
                        return 150;
                    else if (i == 1)
                        return width - 400;
                    else
                        return 50;

                })
                .attr("y", function (d, i) {
                    if (i == 0 || i == 1)
                        return -30;
                    else
                        return tree_start[1] - 70;

                })
                .attr("text-anchor", function (d) {
                    return "start";
                })

                .style("opacity", 1)
                .text(function (d) {

                    return d;
                });












            /* START OF h2 TREE */


            function h2tree(h2_root, tabname) {

                //console.log(h2_root);

                //    console.log(h2color + " " + h1color + " " + mergedcolor);
                //console.log("h2 TREE");
                d3.select("#h2tree").remove();

                h2_radius = 3;

                var h2tree = d3
                    .tree()
                    .size([Math.round(.40 * width), Math.round(.10 * height)]);
                //.size([Math.round(.25 * width), Math.round(.10 * height)]);



                h2_tree = h2tree(h2_root)
                    .sort(function (a, b) {
                        return a.data.data.child.toLowerCase().localeCompare(b.data.data.child.toLowerCase());
                    });


                var data_nodes = h2_tree.descendants();

                //console.log(data_nodes);

                /*  data_nodes = data_nodes.filter(function (d) {
                     //console.log(d.children.length);
                     if (d.data.data.child.includes("A") || d.data.data.child.includes("B") || d.data.data.child.includes("C"))
                         return d;
     
                 }); */

                //console.log(data_nodes);


                var data_links = h2_tree.links();

                /*  data_links = data_links.filter(function (d) {
                     //console.log(d);
                     if (d.source.data.data.child.includes("A") || d.source.data.data.child.includes("B") || d.source.data.data.child.includes("C"))
                         return d;
     
                 }); */

                //console.log(width + " " + Math.round(.25 * width));


                var h2_node = mergedtree_svg
                    .append("g")
                    .attr("id", "h2tree")
                    //.attr("transform", "translate(" + parseInt(width - Math.round(.25 * width) - 100) + "," + 100 + ")")
                    .attr("transform", "translate(" + parseInt(width - Math.round(.40 * width) - 100) + "," + 100 + ")")
                    .selectAll(".h2_node")
                    .data(data_nodes)
                    //.data(h2_tree.descendants())
                    .enter()
                    .append("g")
                    .attr("class", function (d) {
                        //   console.log(d);
                        return d.child;
                    });

                mergedtree_svg.select("#h2tree")
                    .append("rect")
                    .attr('x', -30)
                    .attr('y', -30)
                    .attr('width', Math.round(.4 * width + 50))
                    .attr('height', Math.round(.075 * height + 100))
                    .attr('stroke', 'black')
                    .attr('fill', 'none');


                var h2_link = h2_node
                    .append("path")
                    //.data(h2_tree.links())
                    .data(data_links)
                    // .enter()
                    .attr("class", function (d) {
                        return "h2_link";
                    })
                    //.classed("link", true)
                    .attr("d", function (d) {
                        return "M" + d.source.x + "," + d.source.y
                            + "C" + d.source.x + "," + (d.source.y + d.target.y) / 2
                            + " " + d.target.x + "," + (d.source.y + d.target.y) / 2
                            + " " + d.target.x + "," + (d.target.y);
                    })
                    .style("opacity", function (d) {
                        return 0.5;
                    })
                    //.style("stroke", "#ccc")
                    .style("stroke", "green")
                    .style("fill", "none")
                    .style("stroke-width", "1px");

                h2_node
                    .append("circle")
                    .attr("cx", function (d) {
                        // console.log(d);
                        // console.log(radialPoint(d.x, d.y));
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    })
                    .attr("r", function (d) {
                        //        console.log(radius);
                        //if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //  return (h2_radius - 3) + "px";
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return (h2_radius) + "px";
                    })
                    .attr("class", function (d) {
                        return (
                            "node" + (d.children ? " node--internal" : " node--leaf")
                        );
                    })
                    .attr("id", function (d) {
                        return "h2tree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    .style("fill", function (d) {
                        //if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //return h1color;
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return h2color;

                    })
                    // .style("opacity", 1)

                    .style("opacity", function (d) {
                        return 0.3;
                    })
                    .on("mouseover", function (d, i) {
                        var label = d.data.data.description_child, child = "root", parent = "";
                        if (label.includes("/")) {
                            child = label.substring(label.lastIndexOf("/") + 1, label.length);
                            parent = label.substring(0, label.lastIndexOf("/"));
                        }

                        update_log("node " + label, "node", "display tooltip", "mouseover", "", "", "", "", "");
                        //console.log(parent + " " + child);

                        var type = "";
                        if (d.children || d._children)
                            type = "Folder";
                        else {
                            if (d.data.data.child.includes("."))
                                type = "File";
                            else
                                type = "Folder"
                        }
                        type = "AfterH " + type;
                        var text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'>" + parent + "/<b>" + child + "</b>";



                        d3.select("#tooltip")
                            .html(text)
                            .style("left", parseInt(d3.event.pageX - 200) + "px")
                            .style("top", parseInt(d3.event.pageY + 50) + "px")
                            .style("text-align", "left")
                            .style("opacity", 1);

                        d3.select(this)
                            .transition()
                            .attr("r", 18);
                    })
                    .on("mouseleave", function (d) {

                        /* if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                            d3.select(this)
                                .transition()
                                .attr("r", radius - 3);
                        if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */
                        update_log("node " + label, "node", "hide tooltip", "mouseleave", "", "", "", "", "");


                        if (d3.select(this).style("font-size") != "20px")
                            d3.select(this)
                                .transition()
                                .attr("r", radius - 6);


                        d3.select("#tooltip")
                            .html("")
                            .style("left", 0)
                            .style("top", 0)
                            .style("opacity", 0);

                    });

                h2_node
                    .append("text")
                    .style("font-size", function (d) {
                        //if (d3.select("#fileversion3radio")._groups[0][0].checked == true)
                        //  return "10px";
                        //else
                        return stree_label_size - d.depth;
                        //console.log(data_nodes[0]);
                        //return data_nodes[0].height - 1.5 + "em";
                    })
                    .attr("class", function (d) {
                        return "text h2tree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })

                    .attr("dy", "2em")
                    .attr("x", function (d) {

                        if ((this.previousSibling).getAttribute("class").includes("leaf"))
                            return d.x - 8;
                        else
                            return d.x + 10;
                    })
                    .attr("y", function (d) {
                        if ((this.previousSibling).getAttribute("class").includes("leaf"))
                            return d.y - 10;
                        else
                            return d.y - 30;
                    })
                    .attr("text-anchor", function (d) {
                        return "start";
                    })

                    .style("opacity", function (d) {
                        /*  if (d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion2radio")._groups[0][0].checked == true) {
                             if (d.depth <= 1)
                                 return 1;
                             else
                             return 0;
                         }
                         //  console.log(d);
     
                         else return 1; */
                        // if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true)
                        return 0;
                        // else
                        //   return 1;
                    })
                    .text(function (d) {
                        // console.log(d);
                        var label = d.data.data.child;
                        if (label.includes("_"))
                            label = label.substring(label.indexOf("_") + 1, label.length);
                        if (label.includes("/"))
                            label = label.substring(label.lastIndexOf("/") + 1, label.length);
                        return label;
                    });
            }


            /* END OF h2 TREE*/



            /* START OF h1 TREE */

            function h1tree(h1_root) {

                //console.log(h1_root.children);

                d3.select("#h1tree").remove();

                var h1_radius = 8;

                h1tree = d3
                    .tree()
                    //.nodeSize([]);
                    .size([Math.round(.4 * width), Math.round(.10 * height)]);



                h1_tree = h1tree(h1_root)
                    .sort(function (a, b) {
                        return a.data.data.child.toLowerCase().localeCompare(b.data.data.child.toLowerCase());
                    });





                var h1_node = mergedtree_svg
                    .append("g")
                    .attr("id", "h1tree")
                    .attr("transform", "translate(" + 50 + "," + 100 + ")")
                    .selectAll(".h1_node")
                    .data(h1_tree.descendants())
                    .enter()
                    .append("g")
                    .attr("class", function (d) {
                        //   console.log(d);
                        return d.child;
                    });

                mergedtree_svg.select("#h1tree")
                    .append("rect")
                    .attr('x', -30)
                    .attr('y', -30)
                    .attr('width', Math.round(.4 * width) + 50)
                    .attr('height', Math.round(.075 * height + 100))
                    .attr('stroke', 'black')
                    .attr('fill', 'none');


                /*  var len = h1_node._groups[0].length;
     
                 console.log(h1_node);
     
                 var h1_node_sliced = h1_node._groups[0].slice(1, len);
     
                 console.log(h1_node_sliced); */

                var h1_link = h1_node
                    .append("path")
                    .data(h1_tree.links())
                    // .enter()
                    .attr("class", function (d) {
                        return "h1_link";
                    })
                    //.classed("link", true)
                    .attr("d", function (d) {
                        //console.log(d.source.y + " " + parseInt(d.source.y + parseInt(h1_radius / 2)));
                        return "M" + d.source.x + "," + parseInt(d.source.y + parseInt(h1_radius / 2))
                            + "C" + d.source.x + "," + (d.source.y + d.target.y + parseInt(h1_radius / 2)) / 2
                            + " " + d.target.x + "," + (d.source.y + d.target.y - parseInt(h1_radius / 2)) / 2
                            + " " + d.target.x + "," + (d.target.y - parseInt(h1_radius / 2));
                    })
                    .style("opacity", function (d) {
                        return 0.3;
                    })
                    //.style("stroke", "#ccc")
                    .style("stroke", "red")
                    .style("fill", "none")
                    .style("stroke-width", "1px");

                h1_node
                    .append("circle")
                    .attr("cx", function (d) {
                        // console.log(d);
                        // console.log(radialPoint(d.x, d.y));
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    })
                    .attr("r", function (d) {
                        //if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //  return h1_radius + "px";
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return (h1_radius - 4) + "px";
                    })
                    .attr("class", function (d) {
                        return (
                            "node" + (d.children ? " node--internal" : " node--leaf")
                        );
                    })
                    .attr("id", function (d) {
                        return "h1tree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    .style("fill", function (d) {
                        // if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //return h2color;
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return "white";
                    })
                    .style("stroke", function (d) {
                        //console.log(h2color);
                        // if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //   return "none";
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return h2color;

                    })
                    .style("stroke-width", function (d) {
                        // if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //    return "0px";
                        //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return "2px";

                    })

                    .style("opacity", function (d) {
                        return 0.3;
                    })
                    .on("mouseover", function (d, i) {
                        var label = d.data.data.description_child, child = "root", parent = "";
                        update_log("node " + label, "label", "display tooltip", "mouseover", "", "", "", "", "");

                        if (label.includes("/")) {
                            child = label.substring(label.lastIndexOf("/") + 1, label.length);
                            parent = label.substring(0, label.lastIndexOf("/"));
                        }
                        //console.log(parent + " " + child);

                        var type = "";
                        if (d.children || d._children)
                            type = "Folder";
                        else {
                            if (d.data.data.child.includes("."))
                                type = "File";
                            else
                                type = "Folder"
                        }
                        type = "BeforeH " + type;
                        var text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'>" + parent + "/<b>" + child + "</b>";




                        d3.select("#tooltip")
                            .html(text)
                            .style("left", parseInt(d3.event.pageX - 200) + "px")
                            .style("top", parseInt(d3.event.pageY + 50) + "px")
                            .style("text-align", "left")
                            .style("opacity", 1);

                        if (text.length > 80 && text.length < 120)
                            d3.select("#tooltip")
                                .style("height", "200px");
                        else if (text.length > 120 && text.length < 200)
                            d3.select("#tooltip")
                                .style("height", "250px");
                        else if (text.length > 200)
                            d3.select("#tooltip")
                                .style("height", "350px");


                        d3.select(this)
                            .transition()
                            .attr("r", 15);
                    })
                    .on("mouseleave", function (d) {

                        /* if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                            d3.select(this)
                                .transition()
                                .attr("r", h1_radius - 3);
                        if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */
                        d3.select(this)
                            .transition()
                            .attr("r", h1_radius - 6);


                        d3.select("#tooltip")
                            .html("")
                            .style("left", 0)
                            .style("top", 0)
                            .style("opacity", 0);

                    });



                h1_node
                    .append("text")
                    .style("font-size", function (d) {
                        return stree_label_size - d.depth;
                        //  if (d3.select("10px";
                        //else
                        //  return "20px";
                        //  return (h1_tree.descendants()[0].height + 2) - (d.depth) + "em";
                    })
                    .attr("class", function (d) {
                        return "text h1tree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    //.classed("text", true)
                    //.attr("dy", "80em")
                    .attr("dx", "-2em")
                    .attr("x", function (d) {

                        //console.log(d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class"));
                        if (d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class").includes("leaf"))
                            return d.x - 8;
                        else
                            return d.x + 10;
                    })
                    .attr("y", function (d) {
                        //if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        if (d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class").includes("leaf"))
                            return d.y - 10;
                        else
                            return d.y - 30;
                    })
                    .attr("text-anchor", function (d) {
                        return "start";
                    })

                    .style("opacity", function (d) {
                        /*  if (d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion2radio")._groups[0][0].checked == true) {
                             if (d.depth <= 1)
                                 return 1;
                             else
                             return 0;
                         }
                         //  console.log(d);
     
                         else return 1; */
                        //  if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true)
                        return 0;
                        //else
                        //  return 1;
                    })
                    .text(function (d) {
                        // console.log(d);
                        var label = d.data.data.child;
                        if (label.includes("_"))
                            label = label.substring(label.indexOf("_") + 1, label.length);
                        if (label.includes("/"))
                            label = label.substring(label.lastIndexOf("/") + 1, label.length);
                        return label;
                    });
            }


            /* END OF h1 TREE*/





            /* START OF MERGED TREE */

            function collapse(d) {
                if (d.children) {
                    d._children = d.children
                    d._children.forEach(collapse)
                    d.children = null
                }
            }

            function expand(d) {
                //console.log("EXPAND");
                //console.log(d);
                if (d._children) {
                    d.children = d._children
                    d.children.forEach(expand)
                    d._children = null
                }
            }




            function mergedtree(source, hier_root) {



                //console.log(hier_root);
                var tree = d3
                    .tree()
                    //.nodeSize([9, 10]);
                    .size([1.2 * window.innerWidth, .75 * window.innerHeight]);

                //.size([Math.round(width * .9), Math.round(height * .65)]);
                //.size([Math.round(width * .9), Math.round(height * .75)]);

                //console.log(hier_root);
                var cluster = d3
                    .cluster()
                    //.nodeSize([200, 600]);
                    .size([Math.round(width * .95), Math.round(height * .95)]);


                mtree = tree(hier_root);



                //console.log("MERGED TREE");

                nodes = mtree.descendants();
                links = mtree.links();




                var duration = 500;
                var label_array = [];
                var anchor_array = [];
                var link_strokewidth = 1;
                var link_opacity = 0.7;
                var link_secondaryopacity = 0.2;
                var label_len = 8;


                var triangleColor = "green";
                var triangleSize = 15;
                var triOpacity = 0.6;
                var verticalTransform = Math.sqrt(triangleSize);

                var triangle_shape = d3.symbol()
                    .type(d3.symbolTriangle)
                    .size(triangleSize);



                var node = mergedtree_svg
                    .select("#mergedtree")
                    .selectAll(".nodes")
                    .data(nodes, function (d, i) {

                        return d.data.data.child;

                        //return d.id || (d.id = ++i);
                        //return ++i;
                        //return d.id;
                    });

                var triangle = mergedtree_svg
                    .select("#mergedtree")
                    //.selectAll(".nodes")
                    .selectAll(".triangle")
                    .data(nodes, function (d, i) {
                        return "tri" + d.data.data.child;

                        //return d.id || (d.id = ++i);
                        //return ++i;
                        //return d.id;
                    });



                /*
            // Define the zoom function for the zoomable tree
     
            function zoom() {
                svgGroup.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }
     
     
            // define the zoomListener which calls the zoom function on the "zoom" event constrained within the scaleExtents
            var zoomListener = d3.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
    */

                //console.log(node);



                var nodeEnter = node
                    //.data(mergedtree.descendants())
                    .enter()
                    .append("g")
                    .attr("class", "nodes")
                    .attr("transform", function (d, i) {
                        //console.log(source);
                        //console.log(source.y);
                        var y = (source.data.data.level === 0 ? 50 : source.data.data.level * level_offset);
                        //console.log(source);
                        //console.log("ENTER " + d.data.data.child + " " + source.x + " " + y);

                        return "translate(" + source.x + "," + y + ")";
                    })
                    .on("click", function (d) {
                        update_log("node " + d.data.data.child, "node", "collapse/expand nodes", "click", "", "", "", "", "");
                        //console.log("click");
                        //console.log(hier_root);
                        click(d, hier_root);
                    });


                var triUpdate = nodeEnter
                    .merge(triangle)
                    .transition()
                    .attr("transform", function (d) {

                        var y = (d.data.data.level === 0 ? 50 : d.data.data.level * level_offset);
                        y = + 25;

                        var trans = "translate(" + 0 + "," + y + ")";
                        return trans;

                    })
                    .style("stroke", function (d) {
                        //console.log("tri update");


                        if (source.data.data.child)
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", "none")
                                .style("fill", "none");
                        else
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", triangleColor)
                                .style("fill", triangleColor);


                        if (d.children)
                            return "none";
                        else
                            return triangleColor;


                    })
                    .style("fill", function (d) {
                        if (source.data.data.child)
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", "none")
                                .style("fill", "none");
                        else
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", triangleColor)
                                .style("fill", triangleColor);
                        if (d.children)
                            return "none";
                        else
                            return triangleColor;


                    });




                var nodeUpdate = nodeEnter
                    .merge(node)
                    .transition()
                    //.duration(duration)
                    .attr("transform", function (d) {
                        var y = (d.data.data.level === 0 ? 50 : d.data.data.level * level_offset);
                        return "translate(" + d.x + "," + y + ")";
                    });



                nodeUpdate
                    .selectAll("text")
                    .style("fill-opacity", 1)
                    .style("color", "black");

                /*
            var triExit = triangle
                //.selectAll(".triangle")
                .exit()
                .transition()
                .duration(duration)

                .style("stroke", function (d) {
                    console.log("tri exit");
                    //console.log(d);
                    if (d.parent)
                        if (d.parent.children)
                            return "none";
                        else
                            return triangleColor;

                })
                .style("fill", function (d) {
                    if (d.parent)
                        if (d.parent.children)
                            return "none";
                        else
                            return triangleColor;


                })

                .attr("transform", function (d) {
                    //console.log(d);
                    //var y = (d.parent.data.data.level === 0 ? 50 : d.parent.data.data.level * level_offset);
                    //return "translate(" + d.parent.x + "," + y + ")";

                    var y = (source.data.data.level === 0 ? 50 : source.data.data.level * level_offset);
                    return "translate(" + source.x + "," + y + ")";
                })
                .remove();
                */


                var nodeExit = node
                    //.selectAll("circle")
                    .exit()
                    .transition()
                    .duration(duration)
                    .attr("r", function (d) {
                        console.log("NODE EXIT ");
                        console.log(source);
                        if (source._children)
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", triangleColor)
                                .style("fill", triangleColor);
                        else
                            d3.select(".triangle-" + source.data.id)
                                .style("stroke", "none")
                                .style("fill", "none");


                        return 0;
                    })
                    .attr("transform", function (d) {

                        var y = (source.data.data.level === 0 ? 50 : source.data.data.level * level_offset);
                        return "translate(" + source.x + "," + y + ")";
                    })
                    .remove();



                nodeExit.selectAll("text")
                    .remove();
                //  .style("fill-opacity", 0); 



                var h1index = h1_root.descendants().length;
                //console.log(nodes);
                //console.log(nodes[index - 1]);
                var h1levels = new Array(h1_root.descendants()[h1index - 1].depth + 1).fill(0);


                var h2index = h2_root.descendants().length;
                //console.log(nodes);
                //console.log(nodes[index - 1]);
                var h2levels = new Array(h2_root.descendants()[h2index - 1].depth + 1).fill(0);



                function click(d) {
                    //console.log("click");
                    //console.log(d);
                    //console.log(d.children + " " + !d.children);
                    //console.log(d._children + " " + !d._children);
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    //console.log(d);
                    if (d.children != null || d._children != null)
                        mergedtree(d, hier_root);

                }




                nodeEnter
                    .append("path")
                    .attr("class", function (d) {
                        return "triangle-" + d.data.data.child;
                    })
                    .attr("d", triangle_shape)
                    .attr("x", function (d) {
                        //console.log("tri enter");
                        //console.log(source);
                        return d.x;
                    })
                    .attr("y", function (d) {
                        return d.y + 200;
                    })
                    .style("stroke-width", "5px")
                    .style("stroke", function (d) {
                        //console.log("tri update");
                        //console.log(d);
                        if (d.children)
                            return "none";
                        else
                            return triangleColor;

                    })
                    .style("opacity", triOpacity)
                    .style("fill", function (d) {

                        if (d.children)
                            return "none";
                        else
                            return triangleColor;


                    })

                    .attr("transform", function (d) {
                        var y = (d.data.data.level === 0 ? 50 : d.data.data.level * level_offset);
                        y = + 25;

                        var trans = "translate(" + 0 + "," + y + ")";
                        //var trans = "";



                        return trans;
                    })
                    .on("mouseover", function (d) {
                        //console.log(this);
                        d3.select(this).style("cursor", "default");
                        update_log("node " + d.data.data.description_child, "triangle", "expand/collapse triangle", "click", "", "", "", "", "");
                    });
                   /*  .attr("transform", function (d, i) {

                        var y = (d.data.data.level === 0 ? 50 : d.data.data.level * level_offset);
                        return "translate(" + d.x + "," + y + ")";
                    }) */;





                //console.log("SOLID");
                nodeEnter
                    .append("circle")

                    .attr("r", function (d) {
                        //console.log("NODE ENTER");
                        //   if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                        //     return mtree_radius + "px";
                        // if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return (mtree_radius) + "px";

                    })
                    .attr("class", function (d) {
                        var id = "mergedtree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                        return (
                            "node" + (d.children ? " node--internal " : " node--leaf ") + id + "_inner"
                        );

                    })
                    .attr("id", function (d) {
                        return "mergedtree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    .style("fill", function (d) {
                        //            console.log(d.data.data.shape);
                        //    if (d3.select("#solidshaperadio")._groups[0][0].checked == true) {
                        //console.log("solid");
                        //      console.log(d.data.data.color);
                        //    return d.data.data.color;
                        //}


                        //    else if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) {
                        //console.log("hollow");
                        if (d.data.data.shape == "h2")
                            return "white";
                        else
                            return h2color;
                        //  }



                    })
                    // .style("opacity", 1)
                    //.style("fill", "yellow")
                    .style("stroke", function (d) {
                        if (d.data.data.shape == "h2")
                            return "white";
                        else
                            return h2color;
                    })

                    .style("stroke-dasharray", function (d) {
                        /*  if (d.data.data.bordertype == "solid")
                             return "none";
                         else
         
                             return "8,8.5"; */
                        return "solid";

                    })

                    .style("opacity", function (d) {
                        if (d.data.data.shape == "h2")
                            return 0.1;
                        else
                            return 1;
                    })
                    .on("mouseover", function (d) {
                        var circle_id = this.getAttribute("id");
                        circle_id = circle_id.split("_")[1];

                        console.log("mover");
                        //console.log(circle_id);


                        update_log("node " + circle_id, "node", "hovering on a node", "mouseover", "", "", "", "", "");



                        var root = mtree.descendants()[0];
                        var h2root = h2_tree.descendants()[0];
                        var h1root = h1_tree.descendants()[0];

                        //console.log(h2_root);
                        //console.log(h1_root);

                        var path = [];
                        var h2path = [];
                        var h1path = [];
                        var h2text = "";
                        var h1text = "";


                        for (var i = 0; i < h2_tree.descendants().length; i++) {
                            if (h2_tree.descendants()[i].data.data.child == d.data.data.child) {
                                for (var j = 0; j < h2root.path(h2_tree.descendants()[i]).length; j++)
                                    h2path.push(h2root.path(h2_tree.descendants()[i])[j].data.data.child);
                            }

                        }
                        d3.select("#h2tree")
                            .select("#h2tree_" + circle_id)
                            .style("opacity", 1);

                        d3.select("#h2tree")
                            .selectAll(".text")
                            .selectAll(".h2tree_" + circle_id)
                            .style("opacity", 1);

                        for (var i = 1; i < h2_root.descendants().length; i++) {
                            var name = h2_root.descendants()[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();
                            if (name == circle_id) {
                                var children = (h2_root.descendants()[0]).path(h2_root.descendants()[i]);
                                // console.log(children);

                                var node_id;
                                for (var j = 0; j < children.length; j++) {
                                    // console.log(children[j]);

                                    node_id = children[j].data.id
                                        .replaceAll(/\//g, "")
                                        .replaceAll(".", "")
                                        .replaceAll(" ", "")
                                        .replaceAll("(", "")
                                        .replaceAll(")", "")
                                        .toLowerCase();
                                    //console.log(node_id);
                                    //console.log(children[j]);
                                    d3.select("#h2tree").select("#h2tree_" + node_id).style("opacity", "1");
                                    d3.select("#h2tree").selectAll(".text" + ".h2tree_" + node_id).style("opacity", "1");
                                }

                            }
                        }





                        for (var i = 0; i < h1_tree.descendants().length; i++) {
                            if (h1_tree.descendants()[i].data.data.child == d.data.data.child) {
                                for (var j = 0; j < h1root.path(h1_tree.descendants()[i]).length; j++)
                                    h1path.push(h1root.path(h1_tree.descendants()[i])[j].data.data.child);
                            }

                        }
                        d3.select("#h1tree")
                            .select("#h1tree_" + circle_id)
                            .style("opacity", 1);

                        d3.select("#h1tree")
                            .selectAll(".text")
                            .selectAll(".h1tree_" + circle_id)
                            .style("opacity", 1);
                        //console.log(h1path);


                        for (var i = 1; i < h1_root.descendants().length; i++) {
                            var name = h1_root.descendants()[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();
                            if (name == circle_id) {
                                var children = (h1_root.descendants()[0]).path(h1_root.descendants()[i]);
                                // console.log(children);

                                var node_id;
                                for (var j = 0; j < children.length; j++) {
                                    // console.log(children[j]);
                                    node_id = children[j].data.id
                                        .replaceAll(/\//g, "")
                                        .replaceAll(".", "")
                                        .replaceAll(" ", "")
                                        .replaceAll("(", "")
                                        .replaceAll(")", "")
                                        .toLowerCase();

                                    //console.log(node_id);
                                    //console.log(children[j]);
                                    d3.select("#h1tree").select("#h1tree_" + node_id).style("opacity", "1");
                                    d3.select("#h1tree").selectAll(".text" + "." + node_id).style("opacity", "1");
                                }

                            }
                        }

                        //console.log(circle_id + " " + d3.select(".mergedtree_" + circle_id + "_outer").style("stroke") + " " + d3.select(".mergedtree_" + circle_id + "_inner").style("stroke"));
                        //mlexp
                        if (!(d3.select(".mergedtree_" + circle_id + "_outer").attr("class").includes("selected") && d3.select(".mergedtree_" + circle_id + "_inner").attr("class").includes("selected"))) {
                            if (d3.select(".mergedtree_" + circle_id + "_outer").style("stroke") == "blue") {
                                //console.log("1 outer is red");

                                d3.select(".mergedtree_" + circle_id + "_outer")
                                    .style("stroke", "red")
                                    .style("stroke-width", circle_stroke + 3);
                            }
                            else if (d3.select(".mergedtree_" + circle_id + "_outer").style("stroke") == "none" && d3.select(".mergedtree_" + circle_id + "_inner").style("stroke") == "blue") {
                                //console.log("1 inner is red");

                                d3.select(".mergedtree_" + circle_id + "_inner")
                                    .style("stroke", "red")
                                    .style("stroke-width", circle_stroke + 3);
                            }

                            for (var i = 0; i < root.path(d).length - 1; i++) {
                                path.push(root.path(d)[i].data.data.child);
                                var id = root.path(d)[i].data.data.child
                                    .replaceAll(/\//g, "")
                                    .replaceAll(".", "")
                                    .replaceAll(" ", "")
                                    .replaceAll("(", "")
                                    .replaceAll(")", "")
                                    .toLowerCase();

                                //console.log("others " + id);
                                // console.log(d3.select(".mergedtree_" + id + "_outer").style("stroke") + " " + d3.select(".mergedtree_" + id + "_inner").style("stroke"));
                                if ((d3.select(".mergedtree_" + id + "_outer").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_inner").style("stroke") == "blue") || (d3.select(".mergedtree_" + id + "_outer").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_inner").style("stroke") == "none")) {
                                    //console.log("over red outer " + id);
                                    d3.select(".mergedtree_" + id + "_outer")
                                        .style("stroke", "red")
                                        .style("stroke-width", circle_stroke + 3);
                                }
                                else if (d3.select(".mergedtree_" + id + "_inner").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_outer").style("stroke") == "none") {
                                    //console.log("over red inner " + id);
                                    d3.select(".mergedtree_" + id + "_inner")
                                        .style("stroke", "red")
                                        .style("stroke-width", circle_stroke + 3);
                                }


                            }
                        }



                        //console.log(path);


                        var name = d.data.data.child;
                        var text = "";
                        //console.log(d);
                        //console.log(name);
                        //if (name == undefined)
                        //  name = d.data.data.child;
                        var label = path, child = "root", parent = "";
                        //if (label.includes("/")) {
                        child = path[path.length - 1];
                        path.pop();
                        parent = path.join("/");
                        //child = label.substring(label.lastIndexOf("/") + 1, label.length);
                        //parent = label.substring(0, label.lastIndexOf("/"));
                        //}
                        //console.log(parent + " " + child);

                        var type = "";
                        if (d.children || d._children)
                            type = "Folder";
                        else {
                            if (d.data.data.child.includes("."))
                                type = "File";
                            else
                                type = "Folder"
                        }
                        if (h2path.length == 0)
                            h2text = "Not available in AfterH";
                        else
                            h2text = h2path.join("/");

                        if (h1path.length == 0)
                            h1text = "Not available in BeforeH";
                        else
                            h1text = h1path.join("/");

                        //console.log(h2text == h1text);
                        //console.log(h2text + " " + h1text);

                        if (h2text == h1text)
                            text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'><b>Path in BeforeH and AfterH: </b>" + h2text;
                        else
                            text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'><b>Path in BeforeH: </b>" + h1text + "<hr class='border border-danger border-1 opacity-50'><b>Path in AfterH: </b>" + h2text;


                        d3.select("#tooltip")
                            .html(text)
                            .style("left", parseInt(d3.event.pageX + 100) + "px")
                            .style("top", parseInt(d3.event.pageY) + "px")
                            .style("text-align", "left")
                            .style("opacity", 1);

                        //console.log(text + "     " + text.length);

                        if (text.length > 80 && text.length < 120)
                            d3.select("#tooltip")
                                .style("height", "200px");
                        else if (text.length > 120 && text.length < 200)
                            d3.select("#tooltip")
                                .style("height", "250px");
                        else if (text.length > 200)
                            d3.select("#tooltip")
                                .style("height", "350px");



                        /* d3.select(this)
                            .transition()
                            .attr("r", mtree_radius + 5); */



                        //}


                        // console.log(h2_root.descendants());




                    })
                    .on("mouseleave", function (d) {



                        d3.select("#tooltip")
                            .html("")
                            .style("left", "0px")
                            .style("top", "0px")
                            .style("opacity", 0);


                        var circle_id = this.getAttribute("id");
                        circle_id = circle_id.split("_")[1];

                        console.log("mleave");

                        //mlexp-leave
                        var root = mtree.descendants()[0];
                        for (var i = 0; i < root.path(d).length; i++) {
                            var id = root.path(d)[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();

                            console.log(id);

                            if (d3.select(".mergedtree_" + id + "_outer").style("stroke") == "red") {
                                //if (id == circle_id) {
                                console.log(d3.select(".mergedtree_" + id + "_outer").style("stroke") + " " + d3.select(".mergedtree_" + id + "_inner").style("stroke"));
                                console.log("leave blue outer " + id);
                                //}
                                d3.select(".mergedtree_" + id + "_outer")
                                    .style("stroke", "blue")
                                    .style("stroke-width", circle_stroke);
                            }
                            else if (d3.select(".mergedtree_" + id + "_inner").style("stroke") == "red") {
                                //if (id == circle_id) {
                                console.log(d3.select(".mergedtree_" + id + "_outer").style("stroke") + " " + d3.select(".mergedtree_" + id + "_inner").style("stroke"));
                                console.log("leave blue inner " + id);
                                //}
                                d3.select(".mergedtree_" + id + "_inner")
                                    .style("stroke", "none")
                                    .style("stroke-width", "0px");
                            }


                        }




                        /* if (d3.select("#solidshaperadio")._groups[0][0].checked == true) {
                            d3.select(this)
                                .transition()
                                .attr("r", mtree_radius);
                        }
                        if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) { */
                        /*  d3.select(this)
                             .transition()
                             .attr("r", mtree_radius - 1); */
                        //}


                        d3.select("#h2tree")
                            .selectAll(".node")
                            .style("opacity", 0.3);

                        d3.select("#h1tree")
                            .selectAll(".node")
                            .style("opacity", 0.3);

                        d3.select("#h2tree")
                            .selectAll(".text")
                            .style("opacity", 0);

                        d3.select("#h1tree")
                            .selectAll(".text")
                            .style("opacity", 0);


                        /* if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true) {
                            d3.select("#h2tree")
                                .selectAll(".text")
                                .style("opacity", 0);
     
                            d3.select("#h1tree")
                                .selectAll(".text")
                                .style("opacity", 0);
     
                        }
                        else {
                            d3.select("#h2tree")
                                .selectAll(".text")
                                .style("opacity", 1);
     
                            d3.select("#h1tree")
                                .selectAll(".text")
                                .style("opacity", 1);
     
                        } */



                    });
                // console.log(mergedtree.links());




                //  if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) {
                //console.log("HOLLOW");
                nodeEnter
                    .append("circle")

                    .attr("r", function (d) {

                        //   if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                        return (mtree_radius + 4) + "px";
                    })
                    .attr("class", function (d) {
                        var id = "mergedtree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                        return (
                            "node" + (d.children ? " node--internal " : " node--leaf ") + id + "_outer"
                        );
                    })
                    .attr("id", function (d) {
                        return "mergedtree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    .style("fill", function (d) {
                        return "none";
                    })
                    .style("stroke", function (d) {
                        //if (d.data.data.shape == "h2" || d.data.data.shape == "merged")
                        //  return h2color;
                        //console.log(d);
                        if (d.data.data.shape == "h2" || d.data.data.shape == "merged")
                            return d.data.data.levelcolor;
                        //return h2color;

                        else return "none";
                    })
                    .style("stroke-width", circle_stroke)
                    .style("stroke-dasharray", function (d) {
                        /*  if (d.data.data.bordertype == "solid")
                             return "none";
                         else
                             return "8,8.5"; */
                        //return "10,10";
                        return "solid";

                    })
                    .style("opacity", function (d) {
                        return 1;
                    })
                    .on("mouseover", function (d) {
                        var circle_id = this.getAttribute("id");
                        circle_id = circle_id.split("_")[1];

                        //console.log(circle_id);
                        console.log("mover");


                        update_log("node " + circle_id, "node", "hovering on a node", "mouseover", "", "", "", "", "");



                        var root = mtree.descendants()[0];
                        var h2root = h2_tree.descendants()[0];
                        var h1root = h1_tree.descendants()[0];

                        //console.log(h2_root);
                        //console.log(h1_root);

                        var path = [];
                        var h2path = [];
                        var h1path = [];
                        var h2text = "";
                        var h1text = "";


                        for (var i = 0; i < h2_tree.descendants().length; i++) {
                            if (h2_tree.descendants()[i].data.data.child == d.data.data.child) {
                                for (var j = 0; j < h2root.path(h2_tree.descendants()[i]).length; j++)
                                    h2path.push(h2root.path(h2_tree.descendants()[i])[j].data.data.child);
                            }

                        }
                        d3.select("#h2tree")
                            .select("#h2tree_" + circle_id)
                            .style("opacity", 1);

                        d3.select("#h2tree")
                            .selectAll(".text")
                            .selectAll(".h2tree_" + circle_id)
                            .style("opacity", 1);




                        for (var i = 1; i < h2_root.descendants().length; i++) {
                            var name = h2_root.descendants()[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();
                            if (name == circle_id) {
                                var children = (h2_root.descendants()[0]).path(h2_root.descendants()[i]);
                                // console.log(children);

                                var node_id;
                                for (var j = 0; j < children.length; j++) {
                                    // console.log(children[j]);

                                    node_id = children[j].data.id
                                        .replaceAll(/\//g, "")
                                        .replaceAll(".", "")
                                        .replaceAll(" ", "")
                                        .replaceAll("(", "")
                                        .replaceAll(")", "")
                                        .toLowerCase();
                                    //console.log(node_id);
                                    //console.log(children[j]);
                                    d3.select("#h2tree").select("#h2tree_" + node_id).style("opacity", "1");
                                    d3.select("#h2tree").selectAll(".text" + ".h2tree_" + node_id).style("opacity", "1");
                                }

                            }
                        }





                        for (var i = 0; i < h1_tree.descendants().length; i++) {
                            if (h1_tree.descendants()[i].data.data.child == d.data.data.child) {
                                for (var j = 0; j < h1root.path(h1_tree.descendants()[i]).length; j++)
                                    h1path.push(h1root.path(h1_tree.descendants()[i])[j].data.data.child);
                            }

                        }
                        d3.select("#h1tree")
                            .select("#h1tree_" + circle_id)
                            .style("opacity", 1);

                        d3.select("#h1tree")
                            .selectAll(".text")
                            .selectAll(".h1tree_" + circle_id)
                            .style("opacity", 1);
                        //console.log(h1path);


                        for (var i = 1; i < h1_root.descendants().length; i++) {
                            var name = h1_root.descendants()[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();
                            if (name == circle_id) {
                                var children = (h1_root.descendants()[0]).path(h1_root.descendants()[i]);
                                // console.log(children);

                                var node_id;
                                for (var j = 0; j < children.length; j++) {
                                    // console.log(children[j]);
                                    node_id = children[j].data.id
                                        .replaceAll(/\//g, "")
                                        .replaceAll(".", "")
                                        .replaceAll(" ", "")
                                        .replaceAll("(", "")
                                        .replaceAll(")", "")
                                        .toLowerCase();

                                    //console.log(node_id);
                                    //console.log(children[j]);
                                    d3.select("#h1tree").select("#h1tree_" + node_id).style("opacity", "1");
                                    d3.select("#h1tree").selectAll(".text" + "." + node_id).style("opacity", "1");
                                }

                            }
                        }


                        //mlexp
                        if (!(d3.select(".mergedtree_" + circle_id + "_outer").attr("class").includes("selected") && d3.select(".mergedtree_" + circle_id + "_inner").attr("class").includes("selected"))) {
                            if (d3.select(".mergedtree_" + circle_id + "_outer").style("stroke") == "blue") {
                                //console.log("1 outer is red");

                                d3.select(".mergedtree_" + circle_id + "_outer")
                                    .style("stroke", "red")
                                    .style("stroke-width", circle_stroke + 3);
                            }
                            else if (d3.select(".mergedtree_" + circle_id + "_outer").style("stroke") == "none" && d3.select(".mergedtree_" + circle_id + "_inner").style("stroke") == "blue") {
                                //console.log("1 inner is red");

                                d3.select(".mergedtree_" + circle_id + "_inner")
                                    .style("stroke", "red")
                                    .style("stroke-width", circle_stroke + 3);
                            }


                            for (var i = 0; i < root.path(d).length - 1; i++) {
                                path.push(root.path(d)[i].data.data.child);
                                var id = root.path(d)[i].data.data.child
                                    .replaceAll(/\//g, "")
                                    .replaceAll(".", "")
                                    .replaceAll(" ", "")
                                    .replaceAll("(", "")
                                    .replaceAll(")", "")
                                    .toLowerCase();

                                //console.log("others " + id);
                                // console.log(d3.select(".mergedtree_" + id + "_outer").style("stroke") + " " + d3.select(".mergedtree_" + id + "_inner").style("stroke"));
                                if ((d3.select(".mergedtree_" + id + "_outer").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_inner").style("stroke") == "blue") || (d3.select(".mergedtree_" + id + "_outer").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_inner").style("stroke") == "none")) {
                                    //console.log("over red outer " + id);
                                    d3.select(".mergedtree_" + id + "_outer")
                                        .style("stroke", "red")
                                        .style("stroke-width", circle_stroke + 3);
                                }
                                else if (d3.select(".mergedtree_" + id + "_inner").style("stroke") == "blue" && d3.select(".mergedtree_" + id + "_outer").style("stroke") == "none") {
                                    //console.log("over red inner " + id);
                                    d3.select(".mergedtree_" + id + "_inner")
                                        .style("stroke", "red")
                                        .style("stroke-width", circle_stroke + 3);
                                }


                            }
                        }


                        //console.log(path);


                        var name = d.data.data.child;
                        var text = "";
                        //console.log(d);
                        //console.log(name);
                        //if (name == undefined)
                        //  name = d.data.data.child;
                        var label = path, child = "root", parent = "";
                        //if (label.includes("/")) {
                        child = path[path.length - 1];
                        path.pop();
                        parent = path.join("/");
                        //child = label.substring(label.lastIndexOf("/") + 1, label.length);
                        //parent = label.substring(0, label.lastIndexOf("/"));
                        //}
                        //console.log(parent + " " + child);

                        var type = "";
                        if (d.children || d._children)
                            type = "Folder";
                        else {
                            if (d.data.data.child.includes("."))
                                type = "File";
                            else
                                type = "Folder"
                        }
                        if (h2path.length == 0)
                            h2text = "Not available in AfterH";
                        else
                            h2text = h2path.join("/");

                        if (h1path.length == 0)
                            h1text = "Not available in BeforeH";
                        else
                            h1text = h1path.join("/");

                        //console.log(h2text == h1text);
                        //console.log(h2text + " " + h1text);

                        if (h2text == h1text)
                            text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'><b>Path in BeforeH and AfterH: </b>" + h2text;
                        else
                            text = "<b> " + type + " </b><hr class='border border-danger border-1 opacity-50'><b>Path in BeforeH: </b>" + h1text + "<hr class='border border-danger border-1 opacity-50'><b>Path in AfterH: </b>" + h2text;


                        d3.select("#tooltip")
                            .html(text)
                            .style("left", parseInt(d3.event.pageX + 100) + "px")
                            .style("top", parseInt(d3.event.pageY) + "px")
                            .style("text-align", "left")
                            .style("opacity", 1);

                        //console.log(text + "     " + text.length);

                        if (text.length > 80 && text.length < 120)
                            d3.select("#tooltip")
                                .style("height", "200px");
                        else if (text.length > 120 && text.length < 200)
                            d3.select("#tooltip")
                                .style("height", "250px");
                        else if (text.length > 200)
                            d3.select("#tooltip")
                                .style("height", "350px");



                        /* d3.select(this)
                            .transition()
                            .attr("r", mtree_radius + 5); */



                        //}


                        // console.log(h2_root.descendants());




                    })
                    .on("mouseleave", function (d) {



                        d3.select("#tooltip")
                            .html("")
                            .style("left", "0px")
                            .style("top", "0px")
                            .style("opacity", 0);


                        var circle_id = this.getAttribute("id");
                        circle_id = circle_id.split("_")[1];


                        console.log("mleave");

                        //mlexp-leave
                        var root = mtree.descendants()[0];
                        for (var i = 0; i < root.path(d).length; i++) {
                            var id = root.path(d)[i].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();


                            if (d3.select(".mergedtree_" + id + "_outer").style("stroke") == "red") {
                                if (id == circle_id)
                                    console.log("leave blue outer " + id);
                                d3.select(".mergedtree_" + id + "_outer")
                                    .style("stroke", "blue")
                                    .style("stroke-width", circle_stroke);
                            }
                            else if (d3.select(".mergedtree_" + id + "_inner").style("stroke") == "red") {
                                if (id == circle_id)
                                    console.log("leave blue inner " + id);
                                d3.select(".mergedtree_" + id + "_inner")
                                    .style("stroke", "none")
                                    .style("stroke-width", "0px");
                            }

                        }




                        /* if (d3.select("#solidshaperadio")._groups[0][0].checked == true) {
                            d3.select(this)
                                .transition()
                                .attr("r", mtree_radius);
                        }
                        if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) { */
                        /*  d3.select(this)
                             .transition()
                             .attr("r", mtree_radius - 1); */
                        //}


                        d3.select("#h2tree")
                            .selectAll(".node")
                            .style("opacity", 0.3);

                        d3.select("#h1tree")
                            .selectAll(".node")
                            .style("opacity", 0.3);

                        d3.select("#h2tree")
                            .selectAll(".text")
                            .style("opacity", 0);

                        d3.select("#h1tree")
                            .selectAll(".text")
                            .style("opacity", 0);


                        /* if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true) {
                            d3.select("#h2tree")
                                .selectAll(".text")
                                .style("opacity", 0);
     
                            d3.select("#h1tree")
                                .selectAll(".text")
                                .style("opacity", 0);
     
                        }
                        else {
                            d3.select("#h2tree")
                                .selectAll(".text")
                                .style("opacity", 1);
     
                            d3.select("#h1tree")
                                .selectAll(".text")
                                .style("opacity", 1);
     
                        } */



                    });



                //console.log(label_array);




                nodeEnter
                    .append("text")
                    .attr("transform", function (d) {
                        // if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        return "rotate(65)";
                    })
                    .style("font-size", function (d) {
                        //  if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true) {
                        //    if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        //return "10px";
                        return label_size - d.depth;
                        // else return "5px";
                        //}

                        // else
                        //   return "20px";
                    })
                    .style("stroke", "none")
                    .style("fill", "silver")
                    .attr("class", function (d) {
                        //return d.name
                        return "mergedtree_" + d.data.data.child
                            .replaceAll(/\//g, "")
                            .replaceAll(".", "")
                            .replaceAll(" ", "")
                            .replaceAll("(", "")
                            .replaceAll(")", "")
                            .toLowerCase();
                    })
                    .classed("text", true)
                    // .style("font-size", "20px")
                    .attr("dx", function (d) {



                        // if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        //  return 10;
                        //else 

                        if (d.children)
                            return 30;
                        else
                            return 30;


                    })
                    .attr("dy", function (d) {
                        // if (d3.select("#fileversion2radio")._groups[0][0].checked == true || d3.select("#fileversion3radio")._groups[0][0].checked == true || d3.select("#fileversion6radio")._groups[0][0].checked == true) {
                        //if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        //return "3em";
                        // else 
                        // if ((this.previousSibling).getAttribute("class").includes("leaf"))

                        if (d.children)
                            return 0;
                        else
                            return 20;

                        //}

                        /* else {
                            if ((this.previousSibling).getAttribute("class").includes("leaf"))
                                return "3em";
                            else return "0em";
     
                    }
                     */

                    })
                    .attr("text-anchor", function (d) {
                        return "start";
                    })

                    .style("opacity", function (d) {
                        /*   if (d3.select("#fileversion3radio")._groups[0][0].checked == true) {
                              if (d.depth <= 2)
                                  return 1;
                              else
                                  return 0;
                          }
                          else return 1; */
                        return 1;
                    })
                    /* .attr("transform", function (d) {
                        return "rotate(90)";
                    }) */
                    .text(function (d) {
                        // console.log(d);
                        //var label = d.name;
                        var label = d.data.data.child;
                        if (label.includes("_"))
                            label = label.substring(label.indexOf("/") + 1, label.length);
                        if (label.includes("/"))
                            label = label.substring(label.lastIndexOf("/") + 1, label.length);

                        if (label.length > label_len) {
                            if (label.includes(".")) {
                                var start = label.indexOf(".");
                                var len = label.length;
                                var templen = label.substr(start, len).length;

                                label = label.substring(0, label_len - templen) + label.substr(start, len);

                            }
                            else {
                                label = label.substring(0, label_len);
                            }
                        }

                        return label;
                    })
                    .on("mouseover", function (d) {

                        //console.log();
                        update_log(d3.select(this).attr("id"), "text label", "emphasize label", "mouseover", "", "", "", "", "");

                        if ((document.getElementsByClassName(d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_inner")[0].style.stroke == "blue" && document.getElementsByClassName(d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_outer")[0].style.stroke == "blue") || (document.getElementsByClassName(d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_inner")[0].style.stroke == "none" && document.getElementsByClassName(d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_outer")[0].style.stroke == "blue"))
                            d3.select("." + d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_outer")
                                .style("stroke", "red")
                                .style("stroke-width", circle_stroke + 3);
                        else
                            d3.select("." + d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_inner")
                                .style("stroke", "red");
                        //.style("stroke-width", circle_stroke + 3);




                        d3.select(this)
                            //.attr("transform", "rotate(0)")

                            .style("font-size", 30)
                            .style("fill", "red")
                            .style("cursor", "pointer")
                            .text(d.data.data.child);




                    })
                    .on("mouseleave", function (d) {

                        //console.log();
                        update_log(d3.select(this).attr("id"), "text label", "label default formatting", "mouseleave", "", "", "", "", "");

                        console.log(d3.select(this).style("fill"));
                        if (d3.select(this).style("fill") != "darkorange")
                            d3.select(this)
                                .style("font-size", label_size - d.depth)
                                //.attr("transform", "rotate(65)")
                                .style("fill", "silver")
                                .style("cursor", "default")
                                .text(function (d) {
                                    var label = d.data.data.child;
                                    if (label.includes("_"))
                                        label = label.substring(label.indexOf("/") + 1, label.length);
                                    if (label.includes("/"))
                                        label = label.substring(label.lastIndexOf("/") + 1, label.length);

                                    if (label.length > label_len) {
                                        if (label.includes(".")) {
                                            var start = label.indexOf(".");
                                            var len = label.length;
                                            var templen = label.substr(start, len).length;

                                            label = label.substring(0, label_len - templen) + label.substr(start, len);

                                        }
                                        else {
                                            label = label.substring(0, label_len);
                                        }
                                    }

                                    return label;
                                });


                        if (document.getElementsByClassName(d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_outer")[0].style.stroke == "red")
                            d3.select("." + d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_outer")
                                .style("stroke", "blue")
                                .style("stroke-width", circle_stroke);
                        else
                            d3.select("." + d3.select(this.parentNode)._groups[0][0].children[2].getAttribute("id") + "_inner")
                                .style("stroke", "none");
                        // .style("stroke-width", circle_stroke);







                    });






                /*
                                var index = 0;
                                labels.each(function () {
                                    //console.log(index);
                                    label_array[index].width = this.getBBox().width;
                                    label_array[index].height = this.getBBox().height;
                                    index += 1;
                                });
                
                                console.log(label_array);
                                console.log(anchor_array);
                
                                d3.labeler()
                                    .label(label_array)
                                    .anchor(anchor_array)
                                    .width(width)
                                    .height(height)
                                    .start(100);
                
                                labels
                                    .transition()
                                    .duration(100)
                                    .attr("dx", function (d) {
                                        //console.log(d.x)
                                        //console.log(d.data.data.child + " " + d.x + " " + d.y);
                                        return d.x;
                                    })
                                    .attr("dy", function (d) { return d.y; });
                */



                //normal links
                var link = mergedtree_svg
                    .select("#mergedtree")
                    //.append("g")
                    //.attr("id", "links")
                    .selectAll(".link")
                    .data(links, function (d) {
                        //console.log(d.target.id);
                        return d.target.id;
                    });

                //console.log(link);

                var linkEnter = link
                    .enter()
                    .append("path")
                    .attr("class", function (d) {
                        //console.log(d);
                        if (d.target.data.data.linkcolor == "blue")
                            return "link " + "merged";
                        else if (d.target.data.data.linkcolor == "green")
                            return "link " + "h1parent";
                        else
                            return "link " + "h2parent";
                        //return "link";

                    })
                    // .insert("path", "g")

                    .attr("d", function (d) {

                        var sourcex = source.x, targetx = source.x

                        //console.log(d.source.data.data.child);

                        // if (d3.select("#leavesdiffheightradio")._groups[0][0].checked == true) {
                        //check y pos/
                        var sourcey = source.data.data.level === 0 ? 50 : source.data.data.level * level_offset;
                        var targety = source.data.data.level === 0 ? 50 : source.data.data.level * level_offset;
                        //}
                        sourcey = sourcey + 25;


                        return "M" + sourcex + "," + sourcey
                            + "C" + sourcex + "," + (sourcey + targety) / 2
                            + " " + targetx + "," + (sourcey + targety) / 2
                            + " " + targetx + "," + targety;
                    })
                    .style("opacity", function (d) {
                        /* if (d.parent != "" && d.h2parent == "" && d.h1parent == "")
                            return 0.1;
                        else if (d.h2parent != "" && d.h1parent == "")
                            return 0.7;
                        else if (d.h2parent == "" && d.h1parent != "")
                            return 0.7; */

                        if (d.target.data.data.linkcolor == "blue")
                            return link_secondaryopacity;
                        else
                            return link_opacity;
                    })
                    //.style("stroke", "#ccc")
                    .style("stroke", function (d) {
                        //if (d.source.data.data.shape == "h2" || (d.source.data.data.shape == "h1" && d.source.data.data.linkcolor != "red" && d.target.data.data.linkcolor != "red"))
                        //  return "green";
                        //else
                        return d.target.data.data.linkcolor;
                    })
                    .style("fill", "none")
                    .style("stroke-width", link_strokewidth);


                linkEnter
                    .merge(link)
                    .transition()
                    //.duration(duration)
                    .attr("d", function (d) {
                        //console.log("update");
                        //console.log(d.source.data.data.child);
                        var sourcex = d.source.x, targetx = d.target.x;
                        var sourcey = d.source.data.data.level === 0 ? 50 : d.source.data.data.level * level_offset;
                        var targety = d.target.data.data.level === 0 ? 50 : d.target.data.data.level * level_offset;

                        //sourcey = sourcey + 60;
                        targety = targety - 25;

                        return "M" + sourcex + "," + parseInt(sourcey + 10)
                            + "C" + sourcex + "," + (sourcey + 10 + targety) / 2
                            + " " + targetx + "," + (sourcey + targety) / 2
                            + " " + targetx + "," + (targety + 10);
                    });

                // Transition exiting nodes to the parent's new position.
                link
                    .exit()
                    .transition()
                    .duration(duration)
                    .attr("d", function (d) {
                        //console.log("exit");
                        var sourcex = source.x, targetx = source.x;
                        var sourcey = source.data.data.level === 0 ? 50 : source.data.data.level * level_offset;
                        var targety = source.data.data.level === 0 ? 50 : source.data.data.level * level_offset;
                        return "M" + sourcex + "," + parseInt(sourcey + 10)
                            + "C" + sourcex + "," + (sourcey + 10 + targety) / 2
                            + " " + targetx + "," + (sourcey + targety) / 2
                            + " " + targetx + "," + (targety + 10);
                    })
                    .remove();


                function hidelinks() {
                    console.log("hide links");

                    d3.selectAll(".merged").style("opacity", 0.3);
                    d3.selectAll(".h2parent").style("opacity", 0.7);
                    d3.selectAll(".altlink").remove();
                }

                function showlinks() {

                    console.log("show links");

                    //alternate parent links
                    links
                        .forEach(function (d, i) {


                            d3.selectAll(".h2parent").style("opacity", 0);

                            var altparent = d.target.data.data.alternateparent.replaceAll(/\//g, "").replaceAll(".", "");
                            var child = d.target.data.data.child.replaceAll(/\//g, "").replaceAll(".", "");
                            var h1parent = d.target.data.data.h1parent.replaceAll(/\//g, "").replaceAll(".", "");

                            console.log("c:" + child + " ap:" + altparent + " h2:" + d.target.data.data.h2parent + " h1:" + h1parent);

                            if (altparent != "") {

                                //console.log("c:" + child + " ap:" + altparent + " h2:" + d.target.data.data.h2parent + " h1:" + h1parent);

                                var sourcex = "";
                                var sourcey = "";

                                for (var j = 0; j < nodes.length; j++) {
                                    if (nodes[j].data.data.child == altparent) {
                                        sourcex = nodes[j].x;
                                        sourcey = nodes[j].data.data.level === 0 ? 50 : nodes[j].data.data.level * level_offset;
                                    }
                                }

                                var targetx = d3.select("#mergedtree").select("#mergedtree_" + child.toLowerCase())._groups[0][0].__data__.x;
                                var targety = d.target.data.data.level === 0 ? 50 : d.target.data.data.level * level_offset;

                                d3.select("#mergedtree").append("path")
                                    .attr("class", function (d) {
                                        return "altlink";
                                    })
                                    .classed(altparent + "-" + child, true)
                                    .attr("d", function (d) {

                                        if (targety == sourcey) {
                                            console.log("SAME LEVEL");
                                            if (sourcex < targetx)
                                                return "M" + sourcex + "," + (sourcey + mtree_radius)
                                                    + "L" + sourcex + "," + (sourcey + mtree_radius + 50)
                                                    + "L" + (targetx - mtree_radius - 20) + "," + (targety + mtree_radius + 50)
                                                    + "L" + (targetx - mtree_radius - 20) + "," + (targety - mtree_radius - 50)
                                                    + "L" + (targetx) + "," + (targety - mtree_radius - 50)
                                                    + "L" + (targetx) + "," + (targety + mtree_radius);

                                            else
                                                return "M" + sourcex + "," + (sourcey + mtree_radius)
                                                    + "L" + sourcex + "," + (sourcey + mtree_radius + 50)
                                                    + "L" + (targetx - mtree_radius - 20) + "," + (targety + mtree_radius + 50)
                                                    + "L" + (targetx - mtree_radius - 20) + "," + (targety - mtree_radius - 50)
                                                    + "L" + (targetx) + "," + (targety - mtree_radius - 50)
                                                    + "L" + (targetx) + "," + (targety + mtree_radius);

                                        }

                                        if (targety < sourcey) {
                                            //console.log("RECURSIVE PARENT");
                                            return "M" + targetx + "," + (targety - mtree_radius)
                                                + "L" + targetx + "," + (targety - 50)
                                                + "L" + (targetx + 50) + "," + (targety - 50)
                                                + "L " + (sourcex + 50) + "," + (sourcey + 50)
                                                + "L" + (sourcex) + "," + (sourcey + 50)
                                                + "L" + sourcex + "," + (sourcey + mtree_radius);
                                        }

                                        else {
                                            //console.log("NORMAL LEVEL");
                                            return "M" + sourcex + "," + sourcey
                                                + "C" + sourcex + "," + (sourcey + targety) / 2
                                                + " " + targetx + "," + (sourcey + targety) / 2
                                                + " " + targetx + "," + targety;
                                        }

                                    })
                                    .style("opacity", function (d) {
                                        return 1;
                                    })
                                    .style("stroke", "green")
                                    .style("stroke-dasharray", "3,3")
                                    //.style("stroke-dasharray", "3,3")
                                    .style("fill", "none")
                                    .style("stroke-width", "7px");

                            }

                        });
                }



                nodes.forEach(function (d) {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });

                //console.log(h1_root.descendants());

                for (var n = 0; n < h1_root.descendants().length; n++) {
                    h1levels[h1_root.descendants()[n].depth] = h1_root.descendants()[n].depth === 0 ? 50 : h1_root.descendants()[n].depth * level_offset;
                }

                for (var n = 0; n < h2_root.descendants().length; n++) {
                    h2levels[h2_root.descendants()[n].depth] = h2_root.descendants()[n].depth === 0 ? 50 : h2_root.descendants()[n].depth * level_offset;
                }

                //console.log(nodes[0].height);
                /* var accent = d3
                    .scaleSequential()
                    .domain([0, nodes[0].height])
                    .interpolator(d3.interpolateInferno); */

                var accent = d3
                    // .range(0, nodes[0].height)
                    .scaleOrdinal(["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#19C5C5", "#ff00ff", "#B13148"]);






                if (d3.select("#levellines").empty()) {

                    var levelg = mergedtree_svg
                        .append("g")
                        .attr("id", "levellines")
                        .attr("transform",
                            "translate(" + tree_start[0] + "," + 400 + ")");

                    var n = 0;

                    //for dashed grey beforeH level line

                    d3
                        .select("#levellines")
                        .selectAll("line")
                        .data(h1levels)
                        .enter()
                        .append("line")
                        .attr("id", function (d, i) {
                            //console.log(i);
                            return "line-level-l" + i;
                        })
                        .attr("x1", function (d) {
                            //console.log(d);
                            return 10;

                        })
                        .attr("y1", function (d) {
                            return d + 10;
                        })
                        .attr("x2", function (d) {

                            return width * 1.3;
                        })
                        .attr("y2", function (d) {
                            return d + 10;
                        })
                        .style("stroke", "grey")
                        .style("stroke-width", 2)
                        .style("stroke-dasharray", "2,20")
                        .style("opacity", 0.6);







                    //levels.splice(4, 1);
                    mergedtree_svg
                        .append("g")
                        .attr("id", "levellines-grey-text")
                        .attr("transform",
                            "translate(" + tree_start[0] + "," + tree_start[1] + ")")
                        .selectAll("text")
                        .data(h1levels)
                        .enter()
                        .append("text")
                        .attr("class", function (d, i) {
                            return "h1-text-level" + i;
                        })
                        .style("font-size", "20px")
                        .attr("dy", "3em")
                        .attr("x", function (d) {
                            return -80;
                        })
                        .attr("y", function (d) {
                            return d - 55;
                        })
                        .attr("text-anchor", function (d) {
                            return "start";
                        })
                        .attr("fill", "grey")
                        .text(function (d, i) {
                            //console.log(d + " " + i);
                            return "Level: " + i;
                        })
                        .on("mouseover", function (d) {
                            d3.select(this).style("cursor", "pointer");
                        })
                        .on("click", function (d) {
                            var levelline = d3.select(this).text().split(": ")[1];
                            console.log(levelline);
                            //alert(document.getElementById("line-chart-l" + levelline).style.opacity);
                            if (document.getElementById("line-level-l" + levelline).style.opacity == 0.6) {
                                update_log("line-level-l" + levelline, "level line", "hide level line " + levelline, "click", "", "", "", "", "");
                                d3.select("#line-level-l" + levelline)
                                    .style("opacity", 0);
                            }
                            else {
                                update_log("line-level-l" + levelline, "level line", "show level line " + levelline, "click", "", "", "", "", "");
                                d3.select("#line-level-l" + levelline)
                                    .style("opacity", 0.6);
                            }

                        });




                    levelg
                        .selectAll("text")
                        .data(h2levels)
                        .enter()
                        .append("text")
                        .attr("class", function (d, i) {
                            return "h2-text-level" + i;
                        })
                        .style("font-size", "15px")
                        .attr("dy", "4em")
                        .attr("x", function (d) {
                            //return -150;
                            return width * 1.25;

                        })
                        .attr("y", function (d) {
                            //console.log(d);
                            return d - 75;
                        })
                        .attr("text-anchor", function (d) {
                            return "start";
                        })
                        .attr("fill", function (d, i) {
                            return accent(i);
                        })
                        .text(function (d, i) {
                            return "Level: " + i;
                        })
                        .on("mouseover", function (d) {
                            update_log(d3.select(this).attr("id"), "levelline", "emphasize levelline", "mouseover", "", "", "", "", "");
                            d3.select(this).style("cursor", "pointer");
                        })
                        .on("click", function (d) {
                            var levelline = d3.select(this).text().split(": ")[1];
                            //alert(document.getElementById("line-chart-l" + levelline).style.opacity);
                            if (document.getElementById("line-chart-l" + levelline).style.opacity == 0.7) {
                                update_log("line-chart-l" + levelline, "level line", "hide level line ", "click", "", "", "", "", "");
                                d3.select("#line-chart-l" + levelline)
                                    .style("opacity", 0);
                            }
                            else {
                                update_log("line-chart-l" + levelline, "level line", "show level line ", "click", "", "", "", "", "");
                                d3.select("#line-chart-l" + levelline)
                                    .style("opacity", 0.7);
                            }

                        });
                }




                if (d3.select("#linkbutton").empty()) {
                    mergedtree_svg
                        .append("g")
                        .attr("id", "linkbutton")
                        .on("mouseover", function (d) {
                            update_log(d3.select(this).attr("id"), "linkbutton", "show/hide alternate links", "mouseover", "", "", "", "", "");
                            d3.select(this).style("cursor", "pointer");
                        })
                        .on("click", function (d) {
                            if (d3.selectAll(".altlink")._groups[0].length == 0) {
                                console.log("show");
                                update_log("altlink", "altlink", "show alternate links", "click", "", "", "", "", "");
                                showlinks();
                            }

                            else {
                                console.log("hide");
                                update_log("altlink", "altlink", "hide alternate links", "click", "", "", "", "", "");
                                hidelinks();
                            }
                        });
                    /*  .on("click", function (d) {
                         if (document.getElementsByClassName("link")[0].style.opacity == 0.5) {
                             d3.select("#mergedtree").selectAll(".link").style("opacity", 0);
                             d3.select("#mergedtree").selectAll(".altlink").style("opacity", 0.5);
                         }
                         else {
                             d3.select("#mergedtree").selectAll(".link").style("opacity", 0.5);
                             d3.select("#mergedtree").selectAll(".altlink").style("opacity", 0);
                         }
                     }); */

                    var btn_width = 350;
                    var btn_height = 40;

                    /*  d3.select("#linkbutton")
                         .append("rect")
                         .attr('x', width - btn_width * 2.5)
                         .attr('y', tree_start[1] - 20)
                         .attr("class", "rounded")
                         .attr("height", btn_height)
                         .attr("width", btn_width)
                         .attr("fill", "#4CAF50")
                         //.style("stroke-width", "9px")
                         //.style("stroke", "red")
                         .style("opacity", 1)
                         .style("border-radius", "8px");
     
     
     
                     d3.select("#linkbutton")
                         .append("text")
                         .attr('x', width - btn_width * 2.5 + 5)
                         .attr('y', tree_start[1])
                         .attr("dy", ".40em")
                         .style("font-size", "18px")
                         .style("fill", "white")
                         .text("Show/hide links from TH"); */

                }



                if (d3.select("#btn-level-line").empty()) {
                    mergedtree_svg
                        .append("g")
                        .attr("id", "btn-level-line")
                        .on("mouseover", function (d) {
                            d3.select(this).style("cursor", "pointer");
                        })
                        .on("click", function (d) {
                            //console.log("hi");

                            for (var l = 0; l < h1levels.length; l++) {
                                if (document.getElementById("line-level-l" + l).style.opacity == 0.6) {
                                    d3.select("#line-level-l" + l)
                                        .style("opacity", 0);
                                    update_log("btn-level-line", "button", "hide level lines", "click", "", "", "", "", "");
                                }
                                else {
                                    d3.select("#line-level-l" + l)
                                        .style("opacity", 0.6);
                                    update_log("btn-level-line", "button", "show level lines", "click", "", "", "", "", "");
                                }
                            }
                        });

                    d3.select("#btn-level-line")
                        .append("rect")
                        .attr('x', width - btn_width * 2.3)
                        .attr('y', tree_start[1] - 20)
                        .attr("class", "rounded")
                        .attr("height", btn_height)
                        .attr("width", btn_width)
                        .attr("fill", "#4CAF50")
                        //.style("stroke-width", "5px")
                        //.style("stroke", "red")
                        //.style("opacity", 0.3)
                        .style("border-radius", "5px");

                    d3.select("#btn-level-line")
                        .append("text")
                        .attr('x', width - btn_width * 2.3 + 5)
                        .attr('y', tree_start[1] + 2)
                        .attr("dy", ".40em")
                        .style("font-size", "20px")
                        .style("fill", "white")
                        .text("Show/hide before hierarchy's level lines");

                }



                if (d3.select("#btn-level-chart").empty()) {
                    mergedtree_svg
                        .append("g")
                        .attr("id", "btn-level-chart")
                        .on("mouseover", function (d) {
                            update_log("btn-level-chart " + d3.select(this).attr("id"), "btn-level-chart", "emphasize level chart line", "mouseover", "", "", "", "", "");
                            d3.select(this).style("cursor", "pointer");
                        })
                        .on("click", function (d) {
                            //console.log("hi");

                            for (var l = 0; l < h2levels.length; l++) {
                                if (document.getElementById("line-chart-l" + l).style.opacity == 0.5) {
                                    d3.select("#line-chart-l" + l)
                                        .style("opacity", 0);
                                    update_log("btn-level-chart", "button", "hide level lines", "click", "", "", "", "", "");
                                }
                                else {
                                    d3.select("#line-chart-l" + l)
                                        .style("opacity", 0.5);
                                    update_log("btn-level-chart", "button", "show level lines", "click", "", "", "", "", "");
                                }
                            }
                        });


                    d3.select("#btn-level-chart")
                        .append("rect")
                        .attr('x', width - btn_width * 1.25)
                        .attr('y', tree_start[1] - 20)
                        .attr("class", "rounded")
                        .attr("height", btn_height)
                        .attr("width", btn_width)
                        .attr("fill", "#008CBA")
                        //.style("stroke-width", "5px")
                        //.style("stroke", "red")
                        //.style("opacity", 0.3)
                        .style("border-radius", "5px");


                    d3.select("#btn-level-chart")
                        .append("text")
                        .attr('x', width - btn_width * 1.25 + 10)
                        .attr('y', tree_start[1] + 2)
                        .attr("dy", ".40em")
                        .style("font-size", "20px")
                        .style("fill", "white")
                        .text("Show/hide after hierarchy's level lines");



                    var x = d3.scaleLinear()
                        .range([0, width])
                        .domain([0, width]);


                    var y = d3.scaleLinear()
                        .range([0, height - level_offset])
                        .range([0, height - level_offset]);

                    var xAxis = d3.axisBottom(x);

                    var yAxis = d3.axisLeft(y);

                    mergedtree_svg

                        .append("g")
                        .attr("id", "line-chart")
                        .attr("transform", "translate(" + tree_start[0] + "," + tree_start[1] + ")");

                    mergedtree_svg
                        .select("#line-chart")
                        .append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0,1200)")
                        .call(xAxis);

                    mergedtree_svg
                        .select("#line-chart")
                        .append("g")
                        .attr("class", "y axis")
                        .call(yAxis)

                }







                var datapoints = [];
                var lev = 3;
                //console.log(levels);
                //for (var l = lev - 1; l < lev; l++) {
                for (var l = 0; l < h2levels.length; l++) {


                    if (!d3.select("#line-chart-l" + l).empty())
                        d3.select("#line-chart-l" + l).remove();

                    //console.log(l + " " + levels[l]);

                    datapoints = [];
                    datapoints.push({ "x": 0, "y": l === 0 ? 50 : l * level_offset, "node": "dummy" });

                    var node_levels = nodes
                        .filter(function (d) {
                            //console.log(d);
                            //console.log(d.data.data.child + " level:" + l + " " + d.data.data.level + " " + d.data.data.alternatelevel);
                            if (d.data.data.level == l) {
                                //console.log("actual " + d.data.data.child + " " + d.data.data.level + " " + d.data.data.alternatelevel);
                                datapoints.push({ "x": d.x - 20, "y": d.data.data.level === 0 ? 50 : d.data.data.level * level_offset, "node": d.data.data.child });
                                datapoints.push({ "x": d.x + 20, "y": d.data.data.level === 0 ? 50 : d.data.data.level * level_offset, "node": d.data.data.child });
                                return d;
                            }

                            else if (d.data.data.alternatelevel == l && d.data.data.alternatelevel != "") {
                                //var offset = 100;
                                var offset = 0;
                                if (d.data.data.level < d.data.data.alternatelevel)
                                    offset *= -1;

                                //console.log("alt " + d.data.data.child + " " + d.data.data.level + " " + d.data.data.alternatelevel);
                                datapoints.push({ "x": d.x - 20, "y": d.data.data.level === 0 ? 50 : d.data.data.level * level_offset + offset, "node": d.data.data.child });
                                datapoints.push({ "x": d.x + 20, "y": d.data.data.level === 0 ? 50 : d.data.data.level * level_offset + offset, "node": d.data.data.child });
                                return d;
                            }
                        });


                    datapoints.push({ "x": width * 1.3, "y": h2levels[l], "node": "dummy" });
                    //console.log(node_levels);




                    var line = d3.line()
                        .x(function (d, i) { return d.x; })
                        .y(function (d) {
                            return d.y;
                        })
                        .curve(d3.curveLinear);



                    datapoints.sort(function (x, y) {
                        return d3.ascending(x.x, y.x);
                    });


                    for (let d = datapoints.length - 1; d > 0; d--) {
                        //console.log("keeping " + datapoints[d].node);
                        //console.log("removing " + datapoints[d - 1].node);
                        if (datapoints[d - 1].x == datapoints[d].x) {
                            if (datapoints[d - 1].y == h2levels[l])
                                datapoints.splice(d - 1, 1);
                            else
                                datapoints.splice(d, 1);
                        }

                    }

                    //console.log(datapoints);

                    mergedtree_svg
                        .select("#line-chart")
                        .append("g")
                        .attr("id", "line-chart-l" + l)
                        .style("opacity", 0.5);

                    var fill = "none";
                    // if (d3.select("#fillcolorradio")._groups[0][0].checked)
                    // fill = accent(l);
                    //else if (d3.select("#fillnoneradio")._groups[0][0].checked) {
                    fill = "none";
                    //}

                    mergedtree_svg
                        .select("#line-chart-l" + l)
                        .append("path")
                        .datum(datapoints)
                        .attr("class", "line")
                        .attr("d", line)
                        .attr("stroke-width", 3)
                        .attr("fill", fill)
                        .attr("stroke", function (d) {
                            //console.log(d);
                            return accent(l);
                        });


                }


                //console.log(datapoints);




            }


            /* END OF MERGED TREE */







        }

        function update_log(elementID, elementType, elementDescription, eventDescription, questionID, question, useranswer, answer, score) {
            var date = new Date();


            var logObject = JSON.parse(localStorage.getItem("logObject"));
            logObject.push({
                "date": date.getDate() + "-" + date.getMonth() + "-" + date.getFullYear(),
                "userID": localStorage.getItem("userID"),
                "vizID": localStorage.getItem("vizID"),
                "screenWidth": window.innerWidth,
                "screenHeight": window.innerHeight,
                "pageID": "mergedtree viz page",
                "elementID": elementID,
                "elementType": elementType,
                "elementDescription": elementDescription,
                "eventDescription": eventDescription,
                "overall_timestamp": Math.round(+new Date() / 1000),
                //"phase_timestamp": new Date().getMilliseconds(),
                "questionID": questionID,
                "question": question,
                "useranswer": useranswer,
                "correctanswer": answer,
                "score": score
            });
            localStorage.removeItem("logObject");
            localStorage.setItem("logObject", JSON.stringify(logObject));

        }


    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIHierarchies</title>

    <link rel="icon" href="Images/logo-hcircle-dark.png">

    <style>
        .dot {
            height: 25px;
            width: 25px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot scrolls {
            overflow-x: scroll;
            overflow-y: hidden;
            height: 80px;
            white-space: nowrap
        }


        /************/

        body {
            padding: 50px;
            font-family: Arial;
            font-size: 10px;
        }

        .axis path,
        .axis line {

            stroke: #000;
            stroke-width: 0px;
            opacity: 0;
            shape-rendering: geometricPrecision;
            /*shape-rendering: crispEdges;*/
        }

        /*  .x.axis path {
            display: none;
        } */

        .tick text {

            opacity: 0;
        }

        .line {

            opacity: 0.5;

        }
    </style>
</head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"
    integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.0.1/intro.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>





<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://kit.fontawesome.com/ae1e2e7d99.js" crossorigin="anonymous"></script>
<script src="algorithm.js"></script>
<script src="treeswlinking.html"></script>
<script src="twl-trainingquestions.js"></script>
<script src="twl-guidedtour.js"></script>
<script src="twl-experimentquestions.js"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>





<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.0.1/introjs.min.css" />
<link rel="stylesheet" type="text/css" href="./assets/styles.css" />



<body>





    <div class="container-fluid">
        <div class="row">
            <div class="col-4">

                <fieldset class="border p-2" style="margin-top:150px;">
                    <legend class="w-auto">Choose layout</legend>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="layout_radio" id="highlight_radio">
                        <label class="form-check-label" for="highlight_radio">
                            Highlight common elements
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="layout_radio" id="link_radio" checked>
                        <label class="form-check-label" for="link_radio">
                            Link common elements
                        </label>
                    </div>
                </fieldset>

            </div>

            <div class="col-4" style="border: 2px outset black; margin-top: 2%;" id="qandamodule">
                <p id="question" style="margin-top: 2%;"></p>
                <hr class='border border-primary border-3 opacity-75'>

                <button class="btn btn-outline-success" type="button" data-bs-toggle="collapse" id="btn-hint"
                    data-bs-target="#collapseElement" aria-expanded="false" aria-controls="collapseExample">
                    <i class="fa-solid fa-lightbulb" style="color:rgb(244, 166, 11);"></i> Show hint
                </button>
                <br />
                <div class="collapse" id="collapseElement">

                    <p id="hint" style="background-color: azure; text-align: center; margin-top: 2%;"> </p>

                </div>


                <br>

                <div class="form-check" id="qanda_options">

                </div>



                <div class="btn-group btn-group-md" role="group" aria-label="Basic mixed styles example"
                    style="margin-bottom: 2%;">
                    <button type="button" class="btn btn-md" id="btn-backquestion"
                        style="color: white;background-color:#155446;">Back</button>

                    <button type="button" class="btn btn-md" id="btn-nextquestion"
                        style="margin-left: 10px; color:white;background-color:#155446;">Next</button>
                </div>



            </div>
            <div class=" col-4">
            </div>
        </div>


        <div class="row">
            <div id="content" class="col-12">


            </div>
            <!-- <div class="col-1">
            </div> -->

        </div>





    </div>


    <script>

        var method = "";
        if (d3.select("#highlight_radio")._groups[0][0].checked == true)
            method = "highlight";
        else method = "link";

        var qcounter = -1;
        var logObject = [];


        //LOG FILES
        var fileversion = "File4";

        //var fileversion = "File0";
        var swapdataset = "h1";

        var h1 = "";
        var h2 = "";


        var mtree = "";
        const vizID = "treeswlinking";
        const pageID = "mtree";


        var title = [];

        update_log("", "landed on the treeswlinking page");



        title = ["Base Hierarchy - Log Week 1", "Target Hierarchy - Log Week 2", "Merged Hierarchy - Target mapped onto Base "];

        d3.queue()
            .defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced v2.csv")
            .defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced-v2.csv")
            //.defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
            //.defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
            .await(function (error, h1, h2) {
                if (error) throw error;

                else {
                    h1 = h1;
                    h2 = h2;
                    runScript_tabs(h1, h2);
                }
            });

        d3.select("#btn-swapdataset").on("click", function () {
            update_log("btn-swapdataset", "button", "swapping datasets");

            console.log("Swapdataset");

            fileversion = "File4";



            if (swapdataset == "h1") {
                d3.queue()
                    //.defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced.csv")
                    //.defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced.csv")
                    .defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
                    .defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
                    .await(function (error, h1, h2) {
                        if (error) throw error;

                        else {
                            h1 = h1;
                            h2 = h2;
                            runScript_tabs(h2, h1);
                        }
                    });
                swapdataset = "h2";
            }
            else {
                d3.queue()
                    .defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
                    .defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
                    .await(function (error, h1, h2) {
                        if (error) throw error;

                        else
                            runScript_tabs(h1, h2);
                    });
                swapdataset = "h1";
            }

        });



        d3.select("#highlight_radio").on("change", function () {
            console.log("Radio updated");

            if (d3.select("#highlight_radio")._groups[0][0].checked == true) {
                method = "highlight";
            }
            else {
                method = "link";
            }


            d3.select("#treeswlinking_svg").remove();

            d3.queue()
                //.defer(d3.csv, "File/" + fileversion + "-primaryHA-reduced.csv")
                //.defer(d3.csv, "File/" + fileversion + "-secondaryHE-reduced.csv")
                .defer(d3.csv, "File/" + fileversion + "-primaryH.csv")
                .defer(d3.csv, "File/" + fileversion + "-secondaryH.csv")
                .await(function (error, h1, h2) {
                    if (error) throw error;

                    else {
                        h1 = h1;
                        h2 = h2;
                        runScript_tabs(h2, h1);
                    }
                });


        });


        function runScript_tabs(h1, h2) {

            console.log(h1);
            console.log(h2);


            runScript_treeswlinking(h1, h2);


            var urlpage = new URLSearchParams(window.location.search).get('page');
            //console.log("page reached in mtree " + pageID);

            if (urlpage == "guidedtour") {
                d3.select("#qandamodule")
                    .style("opacity", 0);
                twl_guidedtour();
            }

            else if (urlpage == "trainingquestions") {
                twl_trainingquestions(0);
                qcounter = -1;
            }

            else if (urlpage == "experimentquestions") {
                d3.select("#btn-hint")
                    .remove();

                d3.select("#collapseElement")
                    .remove();

                twl_experimentquestions(0);
            }





        }



        const urlpage = new URLSearchParams(window.location.search).get('page');

        d3.select("#btn-nextquestion")
            .on("click", function () {

                if (qcounter == -1)
                    qcounter = qcounter + 2;
                else
                    qcounter++;

                //console.log("QC " + qcounter);

                if (urlpage == "trainingquestions") {
                    //update_log("btn-nextquestion", "button", "display training question " + qcounter);
                    d3.select("#collapseElement")
                        .attr("class", "collapse");
                    d3.select("#btn-hint")
                        .html("<i class='fa-solid fa-lightbulb' style='color:rgb(244, 166, 11);'></i> Show hint");
                    twl_trainingquestions(qcounter);
                }
                else {
                    //update_log("btn-nextquestion", "button", "display experiment question " + qcounter);
                    twl_experimentquestions(qcounter);
                }
            });

        d3.select("#btn-backquestion")
            .on("click", function () {
                qcounter--;
                if (urlpage == "trainingquestions") {
                    //update_log("btn-backquestion", "button", "display training question " + qcounter);
                    twl_trainingquestions(qcounter);
                }
                else {
                    //update_log("btn-backquestion", "button", "display experiment question " + qcounter);
                    twl_experimentquestions(qcounter);
                }
            });







        /* function filterData(array) {
            for (var i = array.children.length - 1; i >= 0; i--) {

                if (!(array.children[i].data.data.child === 'A' || array.children[i].data.data.child === 'B' || array.children[i].data.data.child === 'C'))
                    array.children.splice(i, 1);

            }

            return array;
        } */

        var width = Math.round(1 * window.innerWidth);
        var height = 2000;
        var level_offset = 150;


        function runScript_treeswlinking(h1, h2) {



            var radius = 18;









            var margin = { top: 30, right: 30, bottom: 30, left: 120 },
                width = 6000 - margin.left - margin.right,
                height = 3000 - margin.top - margin.bottom;



            var treeswlinking_svg = d3
                .select("#content")
                .append("svg")
                .attr("id", "treeswlinking_svg")
                .attr("width", width)
                .attr("height", height);



            stratify = d3
                .stratify()
                .id(function (d) {
                    return d.child;
                })
                .parentId(function (d) {
                    return d.parent;
                });

            var h2_struct = stratify(h2);
            //console.log(h2_struct);

            var h1_struct = stratify(h1);
            //console.log(h1_struct);


            var h1_root = d3.hierarchy(h1_struct);
            var h2_root = d3.hierarchy(h2_struct);

            h2_root.x0 = 0;
            h2_root.y0 = 100;


            /* if (d3.select("#filterdatacheck")._groups[0][0].checked == true) {
                h1_root = filterData(h1_root);
                h2_root = filterData(h2_root);
            } */



            var tree;

            var h1_xpos = 0;
            var h1_ypos = 3300;

            var h2_xpos = 50;
            var h2_ypos = 100;

            var ltree_size = [4000, 1500];
            var mtree_size = [1300, 1000];
            var stree_size = [1000, 500];

            /*  var h1_rot = 180;
             var h2_rot = 0;
 
             var lab_rot = 180;
             var h1_scalex = -1;
             var h1_scaley = 1;
 
             var h2_scalex = 0;
             var h2_scaley = 0; */



            //console.log(h1_root.descendants().length);
            if (h1_root.descendants().length > 0 && h1_root.descendants().length <= 100)
                tree = d3
                    .tree()
                    .size(stree_size);
            else if (h1_root.descendants().length > 100 && h1_root.descendants().length <= 500)
                tree = d3
                    .tree()
                    .size(mtree_size);
            else if (h1_root.descendants().length > 500)
                tree = d3
                    .tree()
                    .size(ltree_size);


            var h1color = "red", h2color = "red", mergedcolor = "green", linkcolor = "blue";





            //h1 tree is 
            //h2 tree is 


            ///////trees next to each other
            if (method != "link") {


                h1_xpos = 1200;
                h1_ypos = 1000;

                h2_xpos = 0;
                h2_ypos = 1000;

                h1color = "yellow", h2color = "red", mergedcolor = "green", linkcolor = "blue";
            }


            /////////////////


            else {
                ////// left right with leaves facing

                h1_xpos = 3000;
                h1_ypos = 100;
                //h1_ypos = 2600;


                h2_xpos = 50;
                h2_ypos = 100;

                /* h1_rot = 270;
                h2_rot = 90;


                h1_scalex = 1;
                h1_scaley = -1;


                h2_scalex = -1;
                h2_scaley = -1;

                lab_rot = 180;

                lab_scalex = 1;
                lab_scaley = -1; */

                h1color = "red", h2color = "red", linkcolor = "blue";

                //////////

            }

            var h1_tree = tree(h1_root);


            var data_nodes = h1_tree.descendants();

            //console.log(data_nodes);

            /*  data_nodes = data_nodes.filter(function (d) {
                 //console.log(d.children.length);
                 if (d.data.data.child.includes("A") || d.data.data.child.includes("B") || d.data.data.child.includes("C"))
                     return d;
            
             }); */

            //console.log(data_nodes);


            var data_links = h1_tree.links();

            /*  data_links = data_links.filter(function (d) {
                 //console.log(d);
                 if (d.source.data.data.child.includes("A") || d.source.data.data.child.includes("B") || d.source.data.data.child.includes("C"))
                     return d;
            
             }); */

            //console.log(data);


            var h1_node = treeswlinking_svg
                .append("g")
                .attr("id", "h1tree")
                .attr("transform", function (d) {
                    //if (method != "link")
                    return "translate(" + h1_xpos + "," + h1_ypos + ")";
                    //else
                    //return "translate(" + h1_xpos + "," + h1_ypos + ") rotate(" + h1_rot + ") scale(" + h1_scalex + "," + h1_scaley + ")";
                })
                //.attr("transform", "translate(" + h1_xpos + "," + h1_ypos + ") rotate(" + h1_rot + " " + h1_xpos + " " + h1_ypos + ")")
                .selectAll(".h1_node")
                .data(data_nodes)
                //.data(h1_tree.descendants())
                .enter()
                .append("g")
                .attr("class", function (d) {
                    //   console.log(d);
                    return d.child;
                });



            /* treeswolinking_svg.select("#h1tree")
                .append("rect")
                .attr('x', -30)
                .attr('y', -30)
                .attr('width', 1400)
                .attr('height', 600)
                .attr('stroke', 'black')
                .attr('fill', 'none'); */

            var h1_root_pos = 1000;

            var h1_link = h1_node
                .append("path")
                //.append("line")
                //.data(h1_tree.links())
                .data(data_links)
                // .enter()
                .attr("class", function (d) {
                    return "h1_link";
                })
                //.classed("link", true)
                .attr("d", function (d) {
                    console.log(Math.abs(h1_root_pos - d.source.y));
                    return "M" + Math.abs(h1_root_pos - d.source.y) + "," + Math.round(d.source.x)
                        + "C" + Math.abs(Math.round((h1_root_pos - d.source.y + h1_root_pos - d.target.y) / 2)) + "," + Math.round(d.source.x)
                        + " " + Math.abs(Math.round((h1_root_pos - d.source.y + h1_root_pos - d.target.y) / 2)) + "," + Math.round(d.target.x)
                        + " " + Math.abs(h1_root_pos - d.target.y) + "," + Math.round(d.target.x);
                })
                /*
                .attr("x1", function (d) {
                    return h1_root_pos - d.source.y;
                })
                .attr("y1", function (d) {
                    return d.source.x;
                })
                .attr("x2", function (d) {
                    return h1_root_pos - d.target.y;
                })
                .attr("y2", function (d) {
                    return d.target.x;
                })
                */
                .style("opacity", function (d) {
                    return 0.5;
                })
                //.style("stroke", "#ccc")
                .style("stroke", linkcolor)
                .style("fill", "none")
                .style("stroke-width", "7px");

            h1_node
                .append("circle")
                .attr("cx", function (d) {
                    //console.log(d);
                    // console.log(radialPoint(d.x, d.y));

                    //console.log(h1_root_pos - d.y);
                    return h1_root_pos - d.y;
                })
                .attr("cy", function (d) {
                    return d.x;
                })
                .attr("r", function (d) {
                    //        console.log(radius);
                    // if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                    //   return (radius - 3) + "px";
                    //if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                    return (radius - 4) + "px";
                })
                .attr("class", function (d) {
                    return (
                        "node" + (d.children ? " node--internal" : " node--leaf")
                    );
                })
                .attr("id", function (d) {
                    return "h1tree_" + d.data.data.child
                        .replaceAll(/\//g, "")
                        .replaceAll(".", "")
                        .replaceAll(" ", "")
                        .replaceAll("(", "")
                        .replaceAll(")", "")
                        .toLowerCase();
                })
                //.style("stroke", h1color)
                .style("fill", function (d) {
                    // if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                    //   return h2color;
                    //  if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                    console.log(h1color);
                    return h1color;

                })
                // .style("opacity", 1)

                .style("opacity", function (d) {
                    return 0.3;
                })
                .on("mouseover", function (d, i) {
                    var name = d.data.data.child;
                    //console.log(name);
                    //if (name == undefined)
                    //name = d.data.data.child;
                    var text = "Element: <b>" + name + "</b><br>Element code: <b>" + d.data.data.child + "</b><br>Parent code: <b>" + d.data.data.parent + "</b>";
                    d3.select("#tooltip")
                        .html(text)
                        .style("left", parseInt(d3.event.pageX - 200) + "px")
                        .style("top", parseInt(d3.event.pageY + 50) + "px")
                        .style("text-align", "left")
                        .style("opacity", 1);

                    d3.select(this)
                        .transition()
                        .attr("r", 15);
                })
                .on("mouseleave", function (d) {

                    /*  if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                         d3.select(this)
                             .transition()
                             .attr("r", radius - 3);
                     if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */
                    d3.select(this)
                        .transition()
                        .attr("r", radius - 6);


                    d3.select("#tooltip")
                        .html("")
                        .style("left", 0)
                        .style("top", 0)
                        .style("opacity", 0);

                });

            h1_node
                .append("text")

                /* .attr("transform", function (d) {
                    var x = 0;
                    var y = 0;
            
                    if ((this.previousSibling).getAttribute("class").includes("leaf")) {
                        x = d.x - 8;
                        y = d.y;
                    }
                    else {
                        x = d.x - 10;
                        y = d.y;
                    }
                    return "rotate(" + lab_rot + "," + x + "," + y + ")";
            
                }) */

                .style("font-size", function (d) {
                    // if (d3.select("#fileversion3radio")._groups[0][0].checked == true)
                    //   return "20px";
                    //else
                    return "40px";
                })
                .attr("class", function (d) {
                    return d.data.data.child
                        .replaceAll(" ", "")
                        .replaceAll("(", "")
                        .replaceAll(")", "")
                        .toLowerCase();
                })
                .classed("text", true)
                .attr("dy", "2em")
                .attr("x", function (d) {

                    if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        return h1_root_pos - d.y - 8;
                    else
                        return h1_root_pos - d.y + 10;
                })
                .attr("y", function (d) {
                    if ((this.previousSibling).getAttribute("class").includes("leaf"))
                        return d.x - 8;
                    else
                        return d.x - 30;
                })
                .attr("text-anchor", function (d) {
                    return "start";
                })

                .style("opacity", function (d) {
                    return 0;
                })
                .text(function (d) {
                    // console.log(d);
                    var label = "";
                    if (d.data.data.description)
                        label = d.data.data.description;
                    else
                        label = d.data.data.child;
                    if (label.includes("/"))
                        label = label.substring(label.lastIndexOf("/") + 1, label.length);
                    return label;
                });







            //////////////// TREESWLINKING H2

            var h2_tree = tree(h2_root);


            //if (h2_scalex == 0 && h2_scaley == 0) {
            var h2_node = treeswlinking_svg
                .append("g")
                .attr("id", "h2tree")
                .attr("transform", "translate(" + h2_xpos + "," + h2_ypos + ")")
                //.attr("transform", "translate(" + h2_xpos + "," + h2_ypos + ") rotate(" + h2_rot + ")")
                //.attr("transform", "translate(" + h2_xpos + "," + h2_ypos + ") rotate(" + h2_rot + " " + h2_xpos + " " + h2_ypos + ")")
                .selectAll(".h2_node")
                .data(h2_tree.descendants())
                .enter()
                .append("g")
                .attr("class", function (d) {
                    //   console.log(d);
                    return d.child;
                });
            //}
            /*
            else
                var h2_node = treeswlinking_svg
                    .append("g")
                    .attr("id", "h2tree")
                    .attr("transform", "translate(" + h2_xpos + "," + h2_ypos + ") rotate(" + h2_rot + ") scale(" + h2_scalex + "," + h2_scaley + ")")
                    //.attr("transform", "translate(" + h2_xpos + "," + h2_ypos + ") rotate(" + h2_rot + " " + h2_xpos + " " + h2_ypos + ")")
                    .selectAll(".h2_node")
                    .data(h2_tree.descendants())
                    .enter()
                    .append("g")
                    .attr("class", function (d) {
                        //   console.log(d);
                        return d.child;
                    });
*/

            /* treeswolinking_svg.select("#h2tree")
                .append("rect")
                .attr('x', -30)
                .attr('y', -30)
                .attr('width', 1500)
                .attr('height', 600)
                .attr('stroke', 'black') 
                .attr('fill', 'none');
            */



            var h2_link = h2_node
                .append("path")
                //.append("line")
                .data(h2_tree.links())
                // .enter()
                .attr("class", function (d) {
                    return "h2_link";
                })
                //.classed("link", true)

                .attr("d", function (d) {
                    //console.log(d);
                    return "M" + d.source.y + "," + d.source.x
                        + "C" + (d.source.y + d.target.y) / 2 + "," + d.source.x
                        + " " + (d.source.y + d.target.y) / 2 + "," + d.target.x
                        + " " + d.target.y + "," + (d.target.x);
                })
                /*
               .attr("x1", function (d) {
                   return d.source.y;
               })
               .attr("y1", function (d) {
                   return d.source.x;
               })
               .attr("x2", function (d) {
                   return d.target.y;
               })
               .attr("y2", function (d) {
                   return d.target.x;
               })
*/

                .style("opacity", function (d) {
                    return 0.3;
                })
                //.style("stroke", "#ccc")
                .style("stroke", linkcolor)
                .style("fill", "none")
                .style("stroke-width", "7px");

            h2_node
                .append("circle")
                .attr("cx", function (d) {
                    // console.log(d);
                    // console.log(radialPoint(d.x, d.y));
                    return d.y;
                })
                .attr("cy", function (d) {
                    return d.x;
                })
                .attr("r", function (d) {
                    //  if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                    //    return radius + "px";
                    // if (d3.select("#hollowshaperadio")._groups[0][0].checked == true)
                    return (radius - 4) + "px";
                })
                .attr("class", function (d) {
                    return (
                        "node" + (d.children ? " node--internal" : " node--leaf")
                    );
                })
                .attr("id", function (d) {
                    return "h2tree_" + d.data.data.child
                        .replaceAll(/\//g, "")
                        .replaceAll(".", "")
                        .replaceAll(" ", "")
                        .replaceAll("(", "")
                        .replaceAll(")", "")
                        .toLowerCase();
                })
                .style("fill", function (d) {
                    /*   if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                          return h1color;
                      if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */

                    // return "white";
                    return h2color;

                })
                //.style("stroke", h2color)
                .style("stroke-width", function (d) {
                    /*   if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                          return "0px";
                      if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */
                    return "5px";

                })

                .style("opacity", function (d) {
                    return 0.3;
                })
                .on("mouseover", function (d, i) {
                    var text = "Element: <b>" + d.data.data.description + "</b><br>Element code: <b>" + d.data.data.child + "</b><br>Parent code: <b>" + d.data.data.parent + "</b>";
                    d3.select("#tooltip")
                        .html(text)

                        .style("left", parseInt(d3.event.pageX - 200) + "px")
                        .style("top", parseInt(d3.event.pageY + 50) + "px")
                        .style("text-align", "left")
                        .style("opacity", 1);

                    d3.select(this)
                        .transition()
                        .attr("r", 15);
                })
                .on("mouseleave", function (d) {

                    /*  if (d3.select("#solidshaperadio")._groups[0][0].checked == true)
                         d3.select(this)
                             .transition()
                             .attr("r", radius - 3);
                     if (d3.select("#hollowshaperadio")._groups[0][0].checked == true) */
                    d3.select(this)
                        .transition()
                        .attr("r", radius - 6);


                    d3.select("#tooltip")
                        .html("")
                        .style("left", 0)
                        .style("top", 0)
                        .style("opacity", 0);

                });



            h2_node
                .append("text")
                .style("font-size", function (d) {
                    /* if (d3.select("#fileversion3radio")._groups[0][0].checked == true)
                        return "20px";
                    else */
                    return "40px";
                })
                .attr("class", function (d) {
                    return d.data.data.child
                        .replaceAll(" ", "")
                        .replaceAll("(", "")
                        .replaceAll(")", "")
                        .toLowerCase();
                })
                .classed("text", true)
                .attr("dy", "2em")
                .attr("x", function (d) {

                    //console.log(d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class"));
                    if (d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class").includes("leaf"))
                        return d.y - 8;
                    else
                        return d.y + 20;
                })
                .attr("y", function (d) {
                    //if ((this.previousSibling).getAttribute("class").includes("leaf"))
                    if (d3.select(this.parentNode)._groups[0][0].children[1].getAttribute("class").includes("leaf"))
                        return d.x - 8;
                    else
                        return d.x - 30;
                })
                .attr("text-anchor", function (d) {
                    return "start";
                })

                .style("opacity", function (d) {
                    //  console.log(d);
                    if (d.depth <= 2)
                        return 1;
                    else
                        return 0;
                })
                .text(function (d) {
                    // console.log(d);
                    var label = "";
                    if (d.data.data.description)
                        label = d.data.data.description;
                    else
                        label = d.data.data.child;
                    if (label.includes("/"))
                        label = label.substring(label.lastIndexOf("/") + 1, label.length);
                    return label;
                });




            //console.log()
            //console.log(h1_tree.descendants());
            //console.log(h2_tree.descendants());

            var x1 = 0, x2 = 0, y1 = 0, y2 = 0, loop_counter = 0;;
            var h1child = "", h2child = "";
            var colorScale = d3.scaleOrdinal(d3.schemeCategory10)

            d3
                .select("#treeswlinking_svg")
                .append("g")
                .attr("id", "lines");
            console.log(h1_tree.descendants().length + " " + h2_tree.descendants().length);

            if (method != "link")
                for (var h1 = 0; h1 < h1_tree.descendants().length; h1++) {
                    for (var h2 = 0; h2 < h2_tree.descendants().length; h2++) {
                        if (h1_tree.descendants()[h1].data.data.child == h2_tree.descendants()[h2].data.data.child) {

                            h1child = h1_tree.descendants()[h1].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();

                            console.log(h1child + " " + mergedcolor);


                            d3.select("#h1tree_" + h1child)
                                .style("fill", mergedcolor);

                            d3.select("#h2tree_" + h1child)
                                .style("fill", mergedcolor);
                            // break;

                        }
                    }
                }

            else {
                for (var h1 = 0; h1 < h1_tree.descendants().length; h1++) {
                    for (var h2 = loop_counter; h2 < h1_tree.descendants().length; h2++) {
                        if (h1_tree.descendants()[h1].data.data.child == h2_tree.descendants()[h2].data.data.child && h1_tree.descendants()[h1].data.height == 0) {
                            //console.log(h1 + " " + h2);
                            //console.log(h2_tree.descendants()[h2].data.data.child + " " + h1_tree.descendants()[h1].data.data.child);

                            //console.log(document.getElementById("h2tree_" + h2_tree.descendants()[h2].data.data.child.toLowerCase()));



                            h1child = h1_tree.descendants()[h1].data.data.child
                                .replaceAll(/\//g, "")
                                .replaceAll(".", "")
                                .replaceAll(" ", "")
                                .replaceAll("(", "")
                                .replaceAll(")", "")
                                .toLowerCase();
                            //h2child = h2_tree.descendants()[h2].data.data.child.toLowerCase().replaceAll("/", "");

                            //console.log(h1child);


                            x1 = document.getElementById("h1tree_" + h1child).getAttribute("cx");
                            y1 = document.getElementById("h1tree_" + h1child).getAttribute("cy");

                            x2 = document.getElementById("h2tree_" + h1child).getAttribute("cx");
                            y2 = document.getElementById("h2tree_" + h1child).getAttribute("cy");



                            //console.log(x2 + " , " + y2);

                            var ctm1 = document.getElementById("h1tree_" + h1child).getCTM();
                            var ctm2 = document.getElementById("h2tree_" + h1child).getCTM();


                            //console.log(ctm2.a + " " + ctm2.b + " " + ctm2.c + " " + ctm2.d + " " + ctm2.e + " " + ctm2.f);

                            // if (d3.select("#lrradio")._groups[0][0].checked == true) {

                            //console.log(parseInt(x2) + " " + ctm2.b);
                            //console.log(parseInt(y2) + " " + ctm2.d);
                            //console.log(ctm2.f + " ");

                            var upd_x1 = (parseInt(x1) * ctm1.a) + (parseInt(y1) * ctm1.c) + ctm1.e;
                            var upd_y1 = (parseInt(x1) * ctm1.b) + (parseInt(y1) * ctm1.d) + ctm1.f;

                            var upd_x2 = (parseInt(x2) * ctm2.a) + (parseInt(y2) * ctm2.c) + ctm2.e;
                            var upd_y2 = (parseInt(x2) * ctm2.b) + (parseInt(y2) * ctm2.d) + ctm2.f;



                            points = [];
                            points.push([upd_x1, upd_y1]);
                            //points.push([(upd_x1 + upd_x2) / 2, (upd_y1 + upd_y2) / 2 - 200]);
                            points.push([upd_x2, upd_y2]);



                            // if (d3.select("#straightlradio")._groups[0][0].checked == true) {
                            //    var pathline = d3.line(points);




                            //  d3
                            //    .select("#treeswlinking_svg")
                            //  .select("#lines")
                            //  .append("line")
                            // .style("stroke", "blue")
                            //.style("fill", "none")
                            //.style("stroke-width", 7)
                            //.style("opacity", 0.3)
                            ////.attr("x1", "transform(" + points[0] + "," + [0] + ")")
                            //.attr("x1", upd_x1)
                            //.attr("y1", upd_y1)
                            //.attr("x2", upd_x2)
                            //.attr("y2", upd_y2);

                            //}



                            //else if (d3.select("#curvedlradio")._groups[0][0].checked == true)  {

                            var pathcurve = d3.line().curve(d3.curveStep);




                            d3
                                .select("#treeswlinking_svg")
                                .select("#lines")
                                .append("path")
                                .attr("d", pathcurve(points))
                                .style("stroke", function () {
                                    //console.log(h1_tree.descendants()[h1].data.depth);
                                    return colorScale(h1_tree.descendants()[h1].data.depth);
                                })
                                .style("fill", "none")
                                .style("stroke-width", 5)
                                .style("opacity", 0.5)
                                .on("mouseover", function (d) {
                                    d3.select(this).style("opacity", 1);
                                })
                                .on("mouseout", function (d) {
                                    d3.select(this).style("opacity", 0.5);
                                });

                            // }




                            //console.log(d3.select("h1tree_" + h1_tree.descendants()[h1].data.data.child).attr("cx"));

                            loop_counter = h2;
                            break;
                        }

                    }

                }
            }


            ////////////////


        }

        function update_log(elementID, elementType, description) {
            var date = new Date();


            var logObject = JSON.parse(localStorage.getItem("logObject"));
            logObject.push({
                "userID": localStorage.getItem("userID"),
                "vizID": vizID,
                "pageID": pageID,
                "elementID": elementID,
                "elementType": elementType,
                "description": description,
                "date": date.getDate() + "-" + date.getMonth() + "-" + date.getFullYear(),
                "overall_timestamp": new Date().getMilliseconds(),
                "phase_timestamp": new Date().getMilliseconds(),
                "questionID": "",
                "question": "",
                "useranswer": "",
                "correctanswer": ""
            });
            localStorage.removeItem("logObject");
            localStorage.setItem("logObject", JSON.stringify(logObject));

        }

    </script>
</body>

</html>